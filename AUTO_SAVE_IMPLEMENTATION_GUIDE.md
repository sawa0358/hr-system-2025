# 自動保存機能実装ガイド

## 概要

HRシステムに包括的な自動保存機能を実装しました。タスク管理と組織図の両方で、データの永続化とバックアップを自動化します。

## 実装された自動保存機能

### 1. 定期的な自動バックアップ
- **頻度**: 1時間ごと
- **対象**: タスク管理全体、組織図全体
- **保存先**: S3バケット
- **形式**: JSON形式のバックアップファイル

### 2. データ変更時の自動保存
- **タスク管理**: ワークスペース・ボード変更時（10秒後）、ボードデータ変更時（30秒後）
- **組織図**: 社員データ変更時（30秒後）
- **デバウンス処理**: 連続する変更をまとめて処理

### 3. ページ離脱時の自動保存
- **トリガー**: ブラウザの`beforeunload`イベント
- **方法**: `navigator.sendBeacon`を使用した同期的な保存
- **対象**: 現在の作業状態を確実に保存

## 実装詳細

### タスク管理 (`app/tasks/page.tsx`)

#### 状態管理
```typescript
// 自動保存の状態
const [autoSaveEnabled, setAutoSaveEnabled] = useState(true)
const [lastAutoSave, setLastAutoSave] = useState<Date | null>(null)
const [autoSaveInterval, setAutoSaveInterval] = useState<NodeJS.Timeout | null>(null)
```

#### 自動保存関数
```typescript
const performAutoSave = async (type: 'workspace' | 'full') => {
  if (!autoSaveEnabled || isSavingToS3) return

  try {
    console.log(`🔄 自動保存を開始: ${type}`)
    
    if (type === 'workspace' && currentWorkspace) {
      await saveWorkspaceToS3()
    } else if (type === 'full') {
      await saveTaskManagementToS3()
    }
    
    setLastAutoSave(new Date())
    console.log(`✅ 自動保存完了: ${type}`)
  } catch (error) {
    console.error(`❌ 自動保存エラー (${type}):`, error)
  }
}
```

#### 自動保存トリガー
1. **定期的な保存**: 1時間ごと
2. **ワークスペース変更時**: 10秒後
3. **ページ離脱時**: 即座に
4. **データ変更時**: 30秒後

### 組織図 (`components/organization-chart.tsx`)

#### 自動保存関数
```typescript
const performAutoSave = useCallback(async () => {
  if (!autoSaveEnabled || isSavingToS3) return

  try {
    console.log('🔄 組織図の自動保存を開始')
    await saveOrgChartToS3()
    setLastAutoSave(new Date())
    console.log('✅ 組織図の自動保存完了')
  } catch (error) {
    console.error('❌ 組織図の自動保存エラー:', error)
  }
}, [autoSaveEnabled, isSavingToS3, saveOrgChartToS3])
```

#### 自動保存トリガー
1. **定期的な保存**: 1時間ごと
2. **社員データ変更時**: 30秒後
3. **ページ離脱時**: 即座に

## UI コントロール

### 自動保存トグル
- **表示**: 自動保存のON/OFF状態
- **操作**: クリックで自動保存の有効/無効を切り替え
- **視覚的フィードバック**: トグルアイコンと色で状態を表示

### 最終保存時刻表示
- **表示**: 最後に自動保存が実行された時刻
- **更新**: 自動保存完了時にリアルタイム更新
- **形式**: 日本時間での時刻表示

## 設定とカスタマイズ

### 自動保存間隔の変更
```typescript
// 定期的な保存間隔（現在: 1時間）
setInterval(() => {
  performAutoSave('full')
}, 60 * 60 * 1000) // ミリ秒単位

// データ変更時の保存遅延（現在: 30秒）
setTimeout(() => {
  performAutoSave('workspace')
}, 30000) // ミリ秒単位
```

### 自動保存の無効化
```typescript
// 自動保存を無効にする
setAutoSaveEnabled(false)
```

## エラーハンドリング

### 自動保存失敗時の処理
- **ログ出力**: コンソールにエラー詳細を記録
- **継続動作**: エラーが発生してもアプリケーションは継続動作
- **再試行**: 次のトリガーで自動的に再試行

### ネットワークエラー対応
- **タイムアウト**: 長時間の応答待ちを回避
- **リトライ**: 一時的なネットワークエラーに対する再試行
- **フォールバック**: 保存失敗時の代替処理

## パフォーマンス考慮事項

### デバウンス処理
- **目的**: 連続する変更をまとめて処理
- **効果**: API呼び出し回数の削減
- **実装**: `setTimeout`と`clearTimeout`を使用

### メモリ管理
- **クリーンアップ**: コンポーネントアンマウント時のタイマー削除
- **リーク防止**: `useEffect`のクリーンアップ関数で適切に処理

## 使用方法

### 自動保存の有効化/無効化
1. タスク管理ページまたは組織図ページにアクセス
2. 自動保存コントロールパネルを確認
3. トグルボタンをクリックしてON/OFFを切り替え

### 手動保存との併用
- **手動保存**: 重要なタイミングで確実に保存
- **自動保存**: 定期的なバックアップとデータ保護
- **併用**: 両方の機能を同時に使用可能

## トラブルシューティング

### 自動保存が動作しない場合
1. **設定確認**: 自動保存がONになっているか確認
2. **権限確認**: S3保存権限があるか確認
3. **ネットワーク確認**: インターネット接続を確認
4. **ログ確認**: ブラウザのコンソールでエラーメッセージを確認

### 保存頻度の調整
- **頻繁すぎる場合**: デバウンス時間を延長
- **少なすぎる場合**: 定期的な保存間隔を短縮

## 今後の拡張予定

### 追加予定機能
1. **保存履歴管理**: 自動保存の履歴表示
2. **保存設定**: ユーザーごとの保存設定
3. **通知機能**: 保存完了時の通知
4. **統計情報**: 保存回数やデータ量の統計

### パフォーマンス改善
1. **差分保存**: 変更部分のみの保存
2. **圧縮**: バックアップファイルの圧縮
3. **並列処理**: 複数データの並列保存

## まとめ

自動保存機能により、以下のメリットが実現されました：

- **データ保護**: 定期的なバックアップによるデータ損失防止
- **ユーザビリティ**: 手動保存の負担軽減
- **信頼性**: ページ離脱時の確実な保存
- **柔軟性**: ON/OFF切り替えによる制御

この実装により、HRシステムのデータ永続化が大幅に改善され、ユーザーの作業効率とデータ安全性が向上しました。
