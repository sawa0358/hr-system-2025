# メール送信機能セットアップガイド

## 📧 概要

このガイドでは、タスク管理システムのメール通知機能を有効化する手順を説明します。

## 🎯 Gmail SMTPを使用した設定

### ステップ1: Googleアプリパスワードの取得

1. **Googleアカウントの2段階認証を有効化**
   - https://myaccount.google.com/security にアクセス
   - 「2段階認証プロセス」をクリック
   - 画面の指示に従って有効化

2. **アプリパスワードを生成**
   - https://myaccount.google.com/apppasswords にアクセス
   - 「アプリを選択」→「その他（カスタム名）」を選択
   - 名前を入力（例: HR System）
   - 「生成」をクリック
   - **16桁のパスワードが表示されます**（スペースなしでコピー）

### ステップ2: ローカル環境の設定

プロジェクトのルートディレクトリにある `.env.local` ファイルを開き、以下を追加または更新してください：

```bash
# =====================================
# メール通知設定（Gmail SMTP）
# =====================================
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_SECURE=false

# あなたのGmailアドレスを入力
SMTP_USER=your-email@gmail.com

# ステップ1で取得した16桁のアプリパスワード（スペースなし）
SMTP_PASS=abcdefghijklmnop

# 送信元として表示されるメールアドレス
MAIL_FROM=your-email@gmail.com
```

**注意**: `your-email@gmail.com` を実際のGmailアドレスに置き換えてください。

### ステップ3: Heroku本番環境の設定

ターミナルで以下のコマンドを実行してください：

```bash
# Gmail SMTP設定
heroku config:set SMTP_HOST=smtp.gmail.com
heroku config:set SMTP_PORT=587
heroku config:set SMTP_SECURE=false

# あなたのGmailアドレスに置き換えてください
heroku config:set SMTP_USER=your-email@gmail.com

# ステップ1で取得したアプリパスワードに置き換えてください
heroku config:set SMTP_PASS=abcdefghijklmnop

# 送信元メールアドレス
heroku config:set MAIL_FROM=your-email@gmail.com
```

### ステップ4: 設定の確認

Herokuの環境変数が正しく設定されているか確認：

```bash
heroku config | grep SMTP
heroku config | grep MAIL
```

### ステップ5: アプリケーションの再起動

```bash
# ローカル環境
npm run dev

# Heroku本番環境（自動的に再起動されますが、手動で再起動する場合）
heroku restart
```

## 📨 メール送信機能の種類

### 実装済みの通知機能

1. **カードメンバー追加通知**
   - カードにメンバーが追加されたときに送信
   - 対象：追加されたメンバー

2. **カード完了通知**
   - カードが完了リストに移動されたときに送信
   - 対象：カードメンバー全員（変更者含む）

3. **カードアーカイブ通知**
   - カードがアーカイブされたときに送信
   - 対象：カードメンバー全員（変更者含む）

4. **期限3日前通知（自動）**
   - 毎日9:00に自動実行
   - 3日後が期限のカードを検出して通知
   - 対象：カードメンバー全員
   - 本番環境では自動的に有効化

## 📨 メール送信のテスト

### テスト方法

1. **カードメンバー追加通知**
   - タスク管理画面でカードを作成
   - カードにメンバーを追加
   - 追加されたメンバーのメールアドレスに通知が送信されます

2. **カード完了通知**
   - カードを作成してメンバーを追加
   - カードを「完了」リストに移動
   - カードメンバー全員に通知が送信されます

3. **カードアーカイブ通知**
   - カードを作成してメンバーを追加
   - カードをアーカイブ
   - カードメンバー全員に通知が送信されます

4. **期限3日前通知**
   - 3日後の日付を期限に設定したカードを作成
   - メンバーを追加
   - 翌日9:00に自動的に通知が送信されます（本番環境のみ）

### メール送信ログの確認

```bash
# Herokuのログを確認
heroku logs --tail | grep mail
```

成功時のログ例：
```
[mail] メール送信成功
```

失敗時のログ例：
```
[mail] SMTP設定が不足しているためメール送信をスキップします。
[mail] メール送信に失敗しました: Invalid login
```

## 🔧 トラブルシューティング

### エラー: "Invalid login"
**原因**: アプリパスワードが間違っているか、2段階認証が無効
**解決策**: 
- 2段階認証が有効か確認
- アプリパスワードを再生成して設定し直す
- スペースを含めずに入力

### エラー: "SMTP configuration is missing"
**原因**: 環境変数が設定されていない
**解決策**: 
- `.env.local` ファイルを確認
- Herokuの環境変数を確認: `heroku config`

### メールが届かない
**原因**: Gmailの送信制限に達している可能性
**解決策**: 
- Gmailは1日500通まで送信可能
- 迷惑メールフォルダを確認
- 送信先のメールアドレスが正しいか確認

### エラー: "Connection timeout"
**原因**: ファイアウォールやネットワーク設定の問題
**解決策**: 
- ポート587が開いているか確認
- プロキシ設定を確認

## 📊 Gmail送信制限

- **1日の送信上限**: 500通
- **1秒あたりの送信**: 制限なし（ただし推奨は1秒1通程度）
- **送信先制限**: なし（任意のメールアドレスに送信可能）

## 🔒 セキュリティのベストプラクティス

1. **アプリパスワードを安全に管理**
   - `.env.local` ファイルをGitにコミットしない
   - 定期的にパスワードを更新

2. **送信元メールアドレスの管理**
   - 専用のGmailアカウントを作成することを推奨
   - 個人のメールアカウントと分離

3. **監視とログ**
   - 定期的にHerokuのログを確認
   - 異常な送信がないかチェック

## 📝 送信されるメールの例

### カードメンバー追加通知

```
件名: タスクにアサインされました

本文:
タスク「〇〇の実装」にアサインされました。

タスクの詳細を確認してください。
```

## 🎨 メールテンプレートのカスタマイズ

メール本文をカスタマイズする場合は、以下のファイルを編集してください：

- `app/api/cards/[cardId]/members/route.ts` - メンバー追加通知
- `lib/mail.ts` - メール送信の基本機能

## 📞 サポート

問題が解決しない場合は、以下の情報を添えてお問い合わせください：

1. エラーメッセージ
2. Herokuログ（`heroku logs --tail`）
3. 環境変数の設定状況（パスワードは除く）

---

**最終更新日**: 2025年11月10日

