# タスク管理S3保存・復元機能 実装ガイド

このドキュメントは、タスク管理のS3保存・復元機能の実装と使用方法について説明します。

---

## 1. 機能概要

この機能は、タスク管理システムのデータ（ワークスペース、ボード、リスト、カード、タスク）をAmazon S3バケットにJSON形式で保存し、必要に応じて過去のバックアップから復元することを可能にします。

### 主な機能

- **ワークスペース保存**: 現在選択中のワークスペース全体をS3に保存します。
- **タスク管理全体バックアップ**: 全ワークスペース、全ボード、全カード、全タスクをS3にバックアップします。
- **S3からの復元**: S3に保存された過去のバックアップ一覧を表示し、選択した時点のデータで現在のデータベースを更新します。
- **自動バックアップ**: 復元操作を行う前に、現在のデータベースの状態を自動的にS3にバックアップします。
- **アクティビティログ**: 保存および復元操作はアクティビティログに記録されます。

---

## 2. 実装詳細

### 2.1. バックエンド (Next.js API Routes)

#### `app/api/workspaces/save/route.ts` (POST)

- **目的**: 現在選択中のワークスペース全体をS3に保存します。
- **処理**:
  1. リクエストボディから `workspaceId` を取得します。
  2. `prisma.workspace.findUnique` を使用して、ワークスペースとその関連データ（ボード、リスト、カード、メンバー）を取得します。
  3. 取得したデータをJSON形式にシリアライズします。
  4. `AWS.S3.PutObjectCommand` を使用して、S3バケットにファイルをアップロードします。ファイル名は `workspaces/workspace-{workspaceId}-{timestamp}.json` となります。
  5. 成功レスポンスを返します。

#### `app/api/workspaces/restore/route.ts` (GET / POST)

- **目的 (GET)**: S3に保存されているワークスペースのバックアップ一覧を取得します。
- **処理 (GET)**:
  1. `AWS.S3.ListObjectsV2Command` を使用して、指定されたプレフィックス (`workspaces/`) に一致するS3オブジェクトのリストを取得します。
  2. 各バックアップのキー、最終更新日時、サイズ、表示名を含むリストを返します。

- **目的 (POST)**: 選択したS3バックアップからワークスペースデータを復元します。
- **処理 (POST)**:
  1. リクエストボディから復元対象の `s3Key` を取得します。
  2. **（重要）** 復元操作の前に、現在のデータベースの状態を自動的にS3にバックアップします。
  3. `AWS.S3.GetObjectCommand` を使用して、指定された `s3Key` のバックアップファイルをS3からダウンロードします。
  4. ダウンロードしたJSONデータをパースし、ワークスペースデータを取得します。
  5. 取得したデータに基づいて、`prisma.$transaction` を使用してデータベースのワークスペース情報を更新します。
  6. 復元操作をアクティビティログに記録します。
  7. 成功レスポンスを返します。

#### `app/api/task-management/backup/route.ts` (POST)

- **目的**: タスク管理システム全体をS3にバックアップします。
- **処理**:
  1. `prisma.workspace.findMany` と `prisma.task.findMany` を使用して、全ワークスペースと全タスクのデータを取得します。
  2. 統計情報（ワークスペース数、ボード数、カード数、タスク数など）を計算します。
  3. 取得したデータをJSON形式にシリアライズします。
  4. `AWS.S3.PutObjectCommand` を使用して、S3バケットにファイルをアップロードします。ファイル名は `task-management/full-backup-{timestamp}.json` となります。
  5. バックアップ履歴をアクティビティログに記録します。
  6. 成功レスポンスを返します。

#### `app/api/task-management/restore/route.ts` (GET / POST)

- **目的 (GET)**: S3に保存されているタスク管理のバックアップ一覧を取得します。
- **処理 (GET)**:
  1. `AWS.S3.ListObjectsV2Command` を使用して、指定されたプレフィックス (`task-management/`) に一致するS3オブジェクトのリストを取得します。
  2. 各バックアップのキー、最終更新日時、サイズ、表示名を含むリストを返します。

- **目的 (POST)**: 選択したS3バックアップからタスク管理全体を復元します。
- **処理 (POST)**:
  1. リクエストボディから復元対象の `s3Key` と `restoreMode` を取得します。
  2. **（重要）** 復元操作の前に、現在のデータベースの状態を自動的にS3にバックアップします。
  3. `AWS.S3.GetObjectCommand` を使用して、指定された `s3Key` のバックアップファイルをS3からダウンロードします。
  4. ダウンロードしたJSONデータをパースし、タスク管理データを取得します。
  5. `restoreMode` が `replace` の場合、既存のデータを削除します。
  6. 取得したデータに基づいて、`prisma.$transaction` を使用してデータベースのタスク管理情報を更新します。
  7. 復元操作をアクティビティログに記録します。
  8. 成功レスポンスを返します。

### 2.2. フロントエンド (`app/tasks/page.tsx`)

- **状態管理**:
  - `isSavingToS3`, `isRestoringFromS3`: 保存・復元処理中のローディング状態を管理します。
  - `availableBackups`: S3から取得したバックアップ一覧を保持します。
  - `showRestoreDialog`, `selectedBackup`: 復元ダイアログの表示状態と選択されたバックアップを管理します。
- **関数**:
  - `saveWorkspaceToS3`: 「ワークスペース保存」ボタンクリック時に呼び出され、`/api/workspaces/save` APIを呼び出します。
  - `saveTaskManagementToS3`: 「全体バックアップ」ボタンクリック時に呼び出され、`/api/task-management/backup` APIを呼び出します。
  - `fetchAvailableBackups`: 「復元」ボタンクリック時（ダイアログ表示前）に呼び出され、`/api/task-management/restore` (GET) APIを呼び出してバックアップ一覧を取得します。
  - `restoreTaskManagementFromS3`: 復元ダイアログでバックアップが選択され、「復元実行」ボタンがクリックされたときに呼び出され、`/api/task-management/restore` (POST) APIを呼び出します。
- **UI要素**:
  - タスク管理ページのヘッダーに「ワークスペース保存」「全体バックアップ」「復元」ボタンを追加。
  - 「復元」ボタンクリック時に、利用可能なバックアップをドロップダウンで選択できるダイアログを表示。
  - `useToast` を使用して、保存・復元操作の成功/失敗をユーザーに通知。

### 2.3. 環境変数

S3へのアクセスには以下の環境変数が必要です。`.env.local` に設定してください。

```dotenv
AWS_ACCESS_KEY_ID=your_aws_access_key_id
AWS_SECRET_ACCESS_KEY=your_aws_secret_access_key
AWS_REGION=ap-northeast-1
S3_BUCKET_NAME=your-hr-system-task-backups
```

### 2.4. 必要なパッケージ

AWS SDK for JavaScript v3 を使用するため、以下のパッケージをインストールする必要があります。

```bash
npm install @aws-sdk/client-s3
```

---

## 3. 使用方法

1. **環境変数の設定**: 上記のAWS認証情報とS3バケット名を `.env.local` に設定します。
2. **S3バケットの準備**: AWSコンソールで、指定した `S3_BUCKET_NAME` のS3バケットを作成します。
3. **アプリケーションの起動**: `npm run dev` または `npm run build && npm start` でアプリケーションを起動します。
4. **タスク管理ページへ移動**: アプリケーションのタスク管理ページにアクセスします。
5. **ワークスペース保存**:
   - ワークスペースを選択した後、ヘッダーにある「ワークスペース保存」ボタンをクリックします。
   - 成功するとトースト通知が表示されます。
6. **タスク管理全体バックアップ**:
   - ヘッダーにある「全体バックアップ」ボタンをクリックします。
   - 成功するとトースト通知が表示されます。
7. **タスク管理復元**:
   - ヘッダーにある「復元」ボタンをクリックします。
   - 復元ダイアログが表示され、利用可能なバックアップがリスト表示されます。
   - 復元したいバックアップを選択し、「復元実行」ボタンをクリックします。
   - 成功するとトースト通知が表示され、タスク管理データが更新されます。

---

## 4. 考慮事項

- **権限**: タスク管理の保存および復元は、適切な権限を持つユーザーのみが実行できます。
- **エラーハンドリング**: APIエンドポイントとフロントエンドの両方で、S3操作中のエラーを適切に処理し、ユーザーにフィードバックを提供します。
- **データ整合性**: 復元時には、ワークスペース、ボード、リスト、カード、タスクの関連性を適切に維持します。
- **パフォーマンス**: 大量のタスク管理データがある場合、S3との通信やデータベース更新に時間がかかる可能性があります。非同期処理とローディング表示でユーザーエクスペリエンスを向上させます。
- **バックアップ戦略**: 復元操作の前に自動的に現在の状態をバックアップすることで、誤操作によるデータ損失を防ぎます。

---

## 5. ファイル構造

```
app/
├── api/
│   ├── workspaces/
│   │   ├── save/route.ts          # ワークスペース保存API
│   │   └── restore/route.ts       # ワークスペース復元API
│   └── task-management/
│       ├── backup/route.ts        # タスク管理全体バックアップAPI
│       └── restore/route.ts       # タスク管理復元API
└── tasks/
    └── page.tsx                   # タスク管理ページ（S3保存・復元UI）

docs/
├── ENV_TASK_MANAGEMENT_S3_EXAMPLE.md    # 環境変数設定例
└── TASK_MANAGEMENT_S3_IMPLEMENTATION_GUIDE.md  # 実装ガイド
```

---

## 6. トラブルシューティング

### よくある問題

1. **S3アクセスエラー**
   - AWS認証情報が正しく設定されているか確認
   - S3バケットが存在し、適切な権限が設定されているか確認

2. **復元時のデータ不整合**
   - 復元前に自動バックアップが作成されているか確認
   - 復元対象のバックアップファイルが破損していないか確認

3. **パフォーマンス問題**
   - 大量のデータがある場合、処理に時間がかかる可能性があります
   - ローディング表示を確認し、処理完了まで待機してください

### ログの確認

- ブラウザの開発者ツールのコンソールでエラーメッセージを確認
- サーバーログでAPIエンドポイントのエラーを確認
- アクティビティログで保存・復元操作の履歴を確認
