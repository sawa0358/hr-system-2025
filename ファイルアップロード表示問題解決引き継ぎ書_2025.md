# ファイルアップロード表示問題解決引き継ぎ書

## 概要
社員詳細画面において、編集時には表示されていたファイルがリロード後に見えなくなる問題を解決しました。

## 問題の詳細

### 発生していた問題
1. **ファイルアップロード表示問題**
   - 編集時：ファイルが表示される
   - リロード後：ファイルが表示されない
   - 新規ファイルアップロード後：表示される

2. **家族構成の永続化問題**
   - 誕生日フィールドが保存されない
   - リロード後に家族構成データが表示されない

## 根本原因

### 1. ファイルアップロード表示問題
- **原因**: `fetchUploadedFiles`関数が`useEffect`内で呼び出されていない
- **詳細**: `employee`プロパティが`null`で渡されるため、`useEffect`内の`if (employee)`条件が満たされない

### 2. 家族構成の永続化問題
- **原因**: 複数の`useEffect`が競合して`setFamilyMembers([])`が実行される
- **詳細**: 古い`useEffect`内で`setFamilyMembers([])`が実行され、新しい`useEffect`で設定したデータを上書き

## 解決策

### 1. ファイルアップロード表示問題の解決

#### 修正前
```typescript
// 社員データが変更された時にフォームデータを更新
React.useEffect(() => {
  if (employee) { // employeeが変更されたら常に更新
    // ... フォームデータの設定
    fetchUploadedFiles(employee.id) // この行が実行されない
  }
}, [employee])
```

#### 修正後
```typescript
// 社員データが変更された時にフォームデータを更新
React.useEffect(() => {
  if (employee && open) { // employeeが変更され、ダイアログが開いている時に更新
    // ... フォームデータの設定
    fetchUploadedFiles(employee.id) // 確実に実行される
  }
}, [employee, open]) // 依存配列にopenを追加
```

### 2. 家族構成の永続化問題の解決

#### 修正前
```typescript
// 古いuseEffect（競合の原因）
useEffect(() => {
  if (employee.familyMembers && employee.familyMembers.length > 0) {
    setFamilyMembers(employee.familyMembers)
  } else {
    setFamilyMembers([]) // これが新しいuseEffectのデータを上書き
  }
}, [employee])

// 新しいuseEffect
useEffect(() => {
  // 家族構成の初期化処理
  setFamilyMembers(mappedFamilyMembers)
}, [employee, latestEmployee])
```

#### 修正後
```typescript
// 古いuseEffectの家族構成処理を削除
useEffect(() => {
  // 家族データの更新は別のuseEffectで処理（競合を避けるため削除）
}, [employee])

// 新しいuseEffectのみを使用
useEffect(() => {
  // 家族構成の初期化処理
  setFamilyMembers(mappedFamilyMembers)
}, [employee, latestEmployee])
```

## 修正したファイル

### 1. `components/employee-detail-dialog.tsx`
- `useEffect`の依存配列を`[employee, open]`に変更
- 古い`useEffect`内の家族構成設定処理を削除
- デバッグログの追加と削除

### 2. `app/api/files/employee/[employeeId]/route.ts`
- デバッグログの追加と削除

### 3. `app/employees/page.tsx`
- `handleEmployeeClick`関数のデバッグログの追加と削除

## 技術的な詳細

### 問題の診断プロセス
1. **デバッグログの追加**: 各段階でログを追加して問題を特定
2. **状態の確認**: `employee`、`open`、`uploadedFiles`の状態を確認
3. **API呼び出しの確認**: `fetchUploadedFiles`が呼び出されているかを確認
4. **依存配列の確認**: `useEffect`の依存配列が正しく動作しているかを確認

### 重要なポイント
- `useEffect`の依存配列は慎重に設定する必要がある
- 複数の`useEffect`が同じ状態を更新する場合は競合を避ける
- デバッグログは問題解決後は削除する

## 今後の注意点

### 1. 類似問題の予防
- 新しい`useEffect`を追加する際は、既存の`useEffect`との競合を確認
- 依存配列は必要最小限に設定
- 状態の更新は一箇所で行う

### 2. デバッグ時の注意
- デバッグログは問題解決後は必ず削除
- 本番環境では`console.log`は使用しない
- エラーログ（`console.error`）は残す

### 3. テスト項目
- 社員詳細画面を開く
- ファイルをアップロードする
- ページをリロードする
- ファイルが表示されることを確認
- 家族構成データが表示されることを確認

## 関連する問題

### 未解決の問題
以下の項目についても同様の問題が発生する可能性があります：

1. **組織名の保存維持**
2. **画像の入力**
3. **所属の選択**
4. **役職の選択**

これらの項目についても、同様の診断プロセスで問題を特定し、解決する必要があります。

## まとめ

今回の問題は、`useEffect`の依存配列の設定と複数の`useEffect`の競合が原因でした。適切な依存配列の設定と競合の回避により、問題を解決することができました。

今後、類似の問題が発生した場合は、この引き継ぎ書を参考にして、同様の診断プロセスで問題を特定し、解決してください。

---

**作成日**: 2025年10月24日  
**作成者**: AI Assistant  
**対象システム**: HR-system  
**問題**: ファイルアップロード表示問題、家族構成永続化問題
