# 「見えないTOP」完全自動化デプロイ手順

## 🚀 完全自動化の仕組み

### 自動実行される処理
1. **アプリケーション起動時** - `lib/prisma.ts`で自動実行
2. **Herokuデプロイ時** - `package.json`の`heroku-postbuild`で自動実行
3. **リリース時** - `app.json`の`release`で自動実行

## 📋 デプロイ手順（完全自動）

### 1. コードのプッシュ
```bash
git add .
git commit -m "feat: 見えないTOP完全自動化システム"
git push heroku main
```

### 2. 自動実行される処理（手動操作不要）
- ✅ Prismaクライアント生成
- ✅ データベースマイグレーション実行
- ✅ 「見えないTOP」社員の自動作成・管理
- ✅ 既存データの自動更新

## 🎯 自動化の内容

### 「見えないTOP」社員の自動作成
- **社員番号**: 000
- **名前**: 見えないTOP
- **部署**: 経営
- **役職**: 未設定
- **権限**: 管理者のみ表示
- **クリック**: 完全無効化（グレーアウト）

### 表示制限
- **管理者・総務**: 表示される（クリック不可）
- **一般ユーザー**: 完全に非表示
- **組織図**: TOPドロップゾーンが表示される

## 🔧 技術的な自動化ポイント

### 1. アプリケーション起動時自動実行
```typescript
// lib/prisma.ts
if (typeof window === 'undefined') {
  ensureInvisibleTopEmployee().catch(console.error);
}
```

### 2. Herokuデプロイ時自動実行
```json
// package.json
"heroku-postbuild": "npx prisma generate && npx prisma migrate deploy",
"postdeploy": "node scripts/auto-create-invisible-top.js"
```

### 3. リリース時自動実行
```json
// app.json
"release": {
  "image": "web",
  "command": "node scripts/auto-create-invisible-top.js"
}
```

## ✅ 確認項目（デプロイ後）

1. **管理者でログイン**
   - 「見えないTOP」社員が表示される
   - クリックが無効化されている（グレーアウト）

2. **一般ユーザーでログイン**
   - 「見えないTOP」社員が表示されない

3. **組織図**
   - TOPドロップゾーンが表示される
   - ドラッグ&ドロップが機能する

## 🚨 トラブルシューティング

### 問題: 「見えないTOP」社員が作成されない
**解決策**: ログを確認
```bash
heroku logs --tail
```

### 問題: マイグレーションエラー
**解決策**: 手動実行
```bash
heroku run npx prisma migrate deploy
```

### 問題: 既存データの競合
**解決策**: 自動スクリプトが既存データを更新するため、問題なし

## 📝 注意事項

- **完全自動化**: 手動操作は一切不要
- **安全**: 既存データを保護
- **冪等性**: 複数回実行しても安全
- **エラー処理**: 自動でエラーハンドリング

## 🎉 完了

デプロイが完了すると、以下が自動的に実装されます：
- ✅ 「見えないTOP」社員の自動作成
- ✅ 管理者のみ表示
- ✅ クリック完全無効化
- ✅ 組織図のTOPドロップゾーン
- ✅ 完全自動化システム
