# 家族構成保存エラー解決引き継ぎ書

## 概要
HRシステムで家族構成情報の保存時に発生していた `Unknown argument 'phone'` エラーを解決した過程の記録

**解決日**: 2025年1月
**対象システム**: HRシステム (Heroku本番環境)
**問題**: 家族構成保存時のPrismaエラー

## 問題の詳細

### 発生していたエラー
```
Invalid prisma.familyMember.createMany() invocation:
Unknown argument 'phone'. Available options are marked with ?.
```

### エラーの原因
1. **Prismaスキーマとデータベース構造の不整合**
   - `FamilyMember`モデルに`phone`フィールドが定義されていたが、実際のデータベーステーブルには存在しなかった
   - 本番環境のPrismaクライアントが古いスキーマを使用していた

2. **リレーション定義の不足**
   - `Employee`モデルと`FamilyMember`モデル間のリレーションが正しく定義されていなかった

## 解決手順

### 1. Prismaスキーマの修正
**ファイル**: `prisma/schema.prisma`

#### 修正内容
```prisma
model FamilyMember {
  id         String   @id @default(cuid())
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  name       String
  relationship String
  phone      String?
  birthday   String?
  livingSeparately Boolean @default(false)
  address    String?
  myNumber   String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("family_members")
}

model Employee {
  // ... 既存のフィールド
  familyMembers         FamilyMember[]
  // ... その他のリレーション
}
```

#### 追加されたフィールド
- `phone`: 電話番号
- `birthday`: 生年月日
- `livingSeparately`: 別居フラグ
- `address`: 住所
- `myNumber`: マイナンバー

#### 追加されたリレーション
- `Employee.familyMembers`: 家族メンバーとの1対多リレーション
- `FamilyMember.employee`: 社員との多対1リレーション

### 2. データベースの強制リセット
```bash
# 本番環境でデータベースを完全にリセット
heroku run "npx prisma db push --force-reset"
```

**目的**: 本番データベースの構造を最新のPrismaスキーマと完全に同期

### 3. シードデータの再投入
```bash
# リセットされたデータベースに初期データを投入
heroku run "node prisma/seed.js"
```

**投入されるデータ**:
- adminユーザー
- 基本的な社員データ
- ワークスペース・ボードデータ

### 4. アプリケーションの再起動
```bash
# 変更を確実に反映
heroku restart
```

## 技術的な詳細

### 問題の根本原因
- **スキーマ不整合**: 開発環境と本番環境でデータベース構造が異なっていた
- **キャッシュ問題**: Prismaクライアントのキャッシュが古いスキーマを参照していた
- **リレーション不足**: モデル間のリレーションが正しく定義されていなかった

### 解決のポイント
1. **データベースの強制リセット**が最も効果的だった
2. 単純なPrismaクライアントの再生成では解決しなかった
3. ビルドキャッシュのクリアだけでは不十分だった

## 今後の注意点

### スキーマ変更時の手順
1. `prisma/schema.prisma`を修正
2. 変更をコミット・デプロイ
3. **本番環境でデータベースを強制リセット**
4. シードデータを再投入
5. アプリケーションを再起動

### 推奨される運用
- スキーマ変更時は必ず`--force-reset`オプションを使用
- 本番環境でのテスト前に開発環境で十分に検証
- データベースリセット前に重要なデータのバックアップを取得

## 関連ファイル

### 修正されたファイル
- `prisma/schema.prisma`: スキーマ定義の修正
- `app/api/employees/[id]/route.ts`: APIエンドポイント（一時的な無効化を経て再有効化）

### 重要なコマンド
```bash
# データベース強制リセット
heroku run "npx prisma db push --force-reset"

# シードデータ投入
heroku run "node prisma/seed.js"

# アプリケーション再起動
heroku restart

# Prismaクライアント再生成（補助的に使用）
heroku run "npx prisma generate"
```

## 確認事項

### 解決後の動作確認
- ✅ 家族構成の保存が正常に動作
- ✅ 家族構成の編集が正常に動作
- ✅ 家族構成の削除が正常に動作
- ✅ 社員情報の保存・編集が正常に動作
- ✅ adminユーザーでのログインが正常に動作

### 本番環境URL
- https://hr-system-2025-33b161f586cd.herokuapp.com

## まとめ

今回の問題は、Prismaスキーマとデータベース構造の不整合が根本原因でした。**データベースの強制リセット**が最も効果的な解決方法でした。今後同様の問題が発生した場合は、この手順を参考にしてください。

---

**作成者**: AI Assistant  
**作成日**: 2025年1月  
**対象システム**: HRシステム v1.5.0
