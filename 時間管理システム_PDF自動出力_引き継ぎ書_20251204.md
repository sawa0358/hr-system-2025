# 時間管理システム PDF自動出力機能 引き継ぎ書

**作成日**: 2025年12月4日  
**コミットハッシュ**: `b26ae41`

---

## 1. 問題の概要

### 報告された問題
- 時間管理システムの全員分PDF出力が保存されていない
- 個人のPDF出力も保存されていない
- 毎月3日に自動出力されるはずが動作していない

---

## 2. 調査結果

### 2.1 コードの状態

| 項目 | ファイル | 状態 |
|------|----------|------|
| 全員分PDF出力 | `/app/api/cron/workclock-monthly-pdf-all/route.ts` | ✅ 実装済み |
| 個人PDF出力 | `/app/api/cron/workclock-monthly-pdf/route.ts` | ✅ 実装済み |

### 2.2 Heroku Scheduler設定

| ジョブ | URL | 状態 |
|--------|-----|------|
| 全員分PDF | `/api/cron/workclock-monthly-pdf-all?token=...` | ✅ 設定済み |
| 個人PDF | `/api/cron/workclock-monthly-pdf?token=...` | ✅ 設定済み |
| 通知 | `/api/cron/notify-pending?token=...` | ✅ 設定済み |

- **実行時刻**: 毎日 3:30 PM UTC（日本時間 翌日 0:30）

### 2.3 環境変数

| 環境変数 | 値 | 状態 |
|----------|-----|------|
| `PAYROLL_ALL_EMPLOYEE_ID` | `cmgtj2n3o00008zcwnsyk1k4n` | ✅ 設定済み |
| `CRON_SECRET_TOKEN` | `82faeb8fd53fb77bd...` | ✅ 設定済み |

---

## 3. 実施した修正

### 3.1 日本時間対応（完了）

**修正内容**: 日付チェックをUTC基準から日本時間基準に変更

```javascript
// 修正前（UTC基準）
const today = new Date()
if (today.getDate() !== 3) { ... }

// 修正後（日本時間基準）
const now = new Date()
const jstDate = new Date(now.getTime() + 9 * 60 * 60 * 1000)
const jstDay = jstDate.getDate()
if (jstDay !== 3) { ... }
```

**対象ファイル**:
- `/app/api/cron/workclock-monthly-pdf-all/route.ts`
- `/app/api/cron/workclock-monthly-pdf/route.ts`

### 3.2 強制実行パラメータ追加（完了）

**修正内容**: `?force=true` パラメータで日付チェックをスキップ可能に

```javascript
const forceRun = request.nextUrl.searchParams.get('force') === 'true'
if (!forceRun && jstDay !== 3) {
  // スキップ
}
```

**テストURL**:
```
https://hr-system-2025-33b161f586cd.herokuapp.com/api/cron/workclock-monthly-pdf-all?token=82faeb8fd53fb77bd06c05f4efdbaa944d2d191ccb609a56a0ceb3558e45596f&force=true
```

### 3.3 Puppeteer buildpack追加（完了）

```bash
heroku buildpacks:add --index 1 https://github.com/jontewks/puppeteer-heroku-buildpack.git
```

---

## 4. 未解決の問題：Chrome/Puppeteer エラー

### 4.1 エラー内容

```json
{
  "error": "月次「全員分」PDF生成処理に失敗しました",
  "details": "Failed to launch the browser process! spawn google-chrome-stable ENOENT"
}
```

### 4.2 原因

- `jontewks/puppeteer-heroku-buildpack` が Heroku-24 スタックで正しくChromeをインストールしていない
- `heroku-buildpack-chrome-for-testing` はスラグサイズ制限（500MB）を超過してしまう

### 4.3 試した解決策

| 解決策 | 結果 |
|--------|------|
| jontewks/puppeteer-heroku-buildpack | ❌ Chrome見つからず |
| heroku-buildpack-google-chrome | ❌ EOL（サポート終了） |
| heroku-buildpack-chrome-for-testing | ❌ スラグサイズ超過（560MB > 500MB） |
| executablePath指定（複数パス） | ❌ いずれも存在せず |

---

## 5. 今後の対応案

### 案A: Puppeteer buildpackの修正（推奨）

1. `jontewks/puppeteer-heroku-buildpack` のフォークを作成
2. Heroku-24対応に修正
3. カスタムbuildpackを使用

### 案B: 代替PDF生成ライブラリの使用

1. `PDFKit` または `jsPDF` でHTML→PDF変換
2. Chromeを使わないため、buildpack不要
3. コードの大幅な書き換えが必要

### 案C: 外部PDF生成サービスの利用

1. **Browserless** (https://browserless.io/)
2. **Puppeteer as a Service**
3. APIでPDF生成を外部委託

### 案D: Herokuダイノのスラグサイズ拡張

1. Heroku Enterprise契約でスラグサイズ制限緩和
2. または、Performance Dynoの検討

---

## 6. 現在のコード構造

### 6.1 全員分PDF出力 (`workclock-monthly-pdf-all`)

```
/app/api/cron/workclock-monthly-pdf-all/route.ts
├── 認証チェック（CRON_SECRET_TOKEN）
├── 日本時間で3日かチェック（force=trueでスキップ可）
├── 全ワーカーの先月データ取得
├── HTMLコンテンツ生成（generateCombinedPDFContent）
├── PuppeteerでPDF化 ← ここでエラー
├── S3/ローカルにアップロード
└── DBにファイルレコード作成
```

### 6.2 個人PDF出力 (`workclock-monthly-pdf`)

```
/app/api/cron/workclock-monthly-pdf/route.ts
├── 認証チェック（CRON_SECRET_TOKEN）
├── 日本時間で3日かチェック（force=trueでスキップ可）
├── 業務委託・外注先ワーカーのみ取得
├── 各ワーカーごとにループ
│   ├── 先月の時間記録取得
│   ├── HTMLコンテンツ生成（generatePDFContent）
│   ├── PuppeteerでPDF化 ← ここでエラー
│   ├── S3/ローカルにアップロード
│   └── DBにファイルレコード作成
└── 結果サマリー返却
```

---

## 7. 関連ファイル一覧

| ファイル | 説明 |
|----------|------|
| `/app/api/cron/workclock-monthly-pdf-all/route.ts` | 全員分PDF cron |
| `/app/api/cron/workclock-monthly-pdf/route.ts` | 個人PDF cron |
| `/lib/workclock/pdf-export.tsx` | PDF HTMLコンテンツ生成 |
| `/app/api/payroll/all-pdfs/route.ts` | 全員分PDF一覧取得API |
| `/app/api/payroll/all-pdfs/[fileId]/download/route.ts` | PDFダウンロードAPI |
| `/components/payroll-upload-dialog.tsx` | 給与管理ダイアログUI |

---

## 8. Heroku設定コマンド

```bash
# 現在のbuildpack確認
heroku buildpacks

# 環境変数確認
heroku config:get PAYROLL_ALL_EMPLOYEE_ID
heroku config:get CRON_SECRET_TOKEN

# ログ確認
heroku logs -n 500 | grep -i "workclock\|pdf\|cron"

# リリース履歴
heroku releases -n 5
```

---

## 9. テスト手順

### 強制実行テスト
```bash
curl -s "https://hr-system-2025-33b161f586cd.herokuapp.com/api/cron/workclock-monthly-pdf-all?token=82faeb8fd53fb77bd06c05f4efdbaa944d2d191ccb609a56a0ceb3558e45596f&force=true"
```

### 期待される成功レスポンス
```json
{
  "success": true,
  "targetMonth": "2025年11月",
  "ownerEmployeeId": "cmgtj2n3o00008zcwnsyk1k4n",
  "fileId": "...",
  "filePath": "...",
  "totalWorkers": 10,
  "workersWithEntries": 5,
  "message": "全員分の勤務報告書PDFを勤怠管理フォルダに保存しました"
}
```

### 現在のエラーレスポンス
```json
{
  "error": "月次「全員分」PDF生成処理に失敗しました",
  "details": "Failed to launch the browser process! spawn google-chrome-stable ENOENT"
}
```

---

## 10. 優先度と次のアクション

### 高優先度
1. **Chrome/Puppeteer問題の解決** - PDF生成機能が完全に動作しない

### 中優先度
2. Heroku Schedulerの時刻調整（必要に応じて）

### 低優先度
3. エラーハンドリングの改善
4. ログ出力の充実

---

## 11. 参考リンク

- [Puppeteer Heroku Buildpack](https://github.com/jontewks/puppeteer-heroku-buildpack)
- [Heroku Chrome for Testing Buildpack](https://github.com/heroku/heroku-buildpack-chrome-for-testing)
- [Puppeteer Troubleshooting](https://pptr.dev/troubleshooting)
- [Heroku Slug Size](https://devcenter.heroku.com/articles/slug-size)

---

**作成者**: AI Assistant  
**最終更新**: 2025年12月4日 02:30 JST



