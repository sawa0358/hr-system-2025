# 時間管理システム（WorkClock）保存永続化調査レポート

**調査日**: 2025年1月  
**調査対象**: WorkClock（業務委託時間管理システム）  
**調査目的**: 保存できる箇所全てでPostgreSQLへの永続保存ができているかの確認

---

## 調査結果サマリー

### ❌ 重大な問題発見

**フロントエンドがAPIを使用しておらず、全てlocalStorageに依存しているため、PostgreSQLへの永続保存が行われていません。**

---

## 1. データベーススキーマ（PostgreSQL）

### 実装済みテーブル

以下のテーブルが`prisma/schema.prisma`に定義されており、PostgreSQLへの保存に対応しています：

1. **WorkClockWorker** (`workclock_workers`)
   - ワーカー情報（社員ID、名前、時給、チーム、ロールなど）
   - 時給パターン（A/B/C）、回数パターン、月額固定設定
   - 消費税設定

2. **WorkClockTimeEntry** (`workclock_time_entries`)
   - 勤務時間記録（日付、開始時刻、終了時刻、休憩時間、メモ）
   - 時給パターン、回数パターン、回数

3. **WorkClockReward** (`workclock_rewards`)
   - 特別報酬・経費（金額、説明、日付）

4. **WorkClockRewardPreset** (`workclock_reward_presets`)
   - 報酬プリセット（金額、説明、有効/無効）

5. **WorkClockTeam** (`workclock_teams`)
   - チーム情報（名前）

---

## 2. APIエンドポイント実装状況

### ✅ 実装済み（PostgreSQL保存対応）

以下のAPIエンドポイントが実装されており、**PostgreSQLへの保存処理が正しく実装されています**：

#### 2.1 時間記録（Time Entries）

| エンドポイント | メソッド | 実装状況 | PostgreSQL保存 |
|--------------|---------|---------|---------------|
| `/api/workclock/time-entries` | GET | ✅ | ✅ |
| `/api/workclock/time-entries` | POST | ✅ | ✅ |
| `/api/workclock/time-entries/[id]` | GET | ✅ | ✅ |
| `/api/workclock/time-entries/[id]` | PUT | ✅ | ✅ |
| `/api/workclock/time-entries/[id]` | DELETE | ✅ | ✅ |

**実装ファイル**: `app/api/workclock/time-entries/route.ts`, `app/api/workclock/time-entries/[id]/route.ts`

**保存処理**:
- POST: `prisma.workClockTimeEntry.create()` でPostgreSQLに保存
- PUT: `prisma.workClockTimeEntry.update()` でPostgreSQLに更新
- DELETE: `prisma.workClockTimeEntry.delete()` でPostgreSQLから削除

#### 2.2 ワーカー（Workers）

| エンドポイント | メソッド | 実装状況 | PostgreSQL保存 |
|--------------|---------|---------|---------------|
| `/api/workclock/workers` | GET | ✅ | ✅ |
| `/api/workclock/workers` | POST | ✅ | ✅ |
| `/api/workclock/workers/[id]` | GET | ✅ | ✅ |
| `/api/workclock/workers/[id]` | PUT | ✅ | ✅ |
| `/api/workclock/workers/[id]` | DELETE | ✅ | ✅ |

**実装ファイル**: `app/api/workclock/workers/route.ts`, `app/api/workclock/workers/[id]/route.ts`

**保存処理**:
- POST: `prisma.workClockWorker.create()` でPostgreSQLに保存
- PUT: `prisma.workClockWorker.update()` でPostgreSQLに更新
- DELETE: `prisma.workClockWorker.deleteMany()` でPostgreSQLから削除

#### 2.3 特別報酬・経費（Rewards）

| エンドポイント | メソッド | 実装状況 | PostgreSQL保存 |
|--------------|---------|---------|---------------|
| `/api/workclock/rewards` | GET | ✅ | ✅ |
| `/api/workclock/rewards` | POST | ✅ | ✅ |
| `/api/workclock/rewards/[id]` | PUT | ✅ | ✅ |
| `/api/workclock/rewards/[id]` | DELETE | ✅ | ✅ |

**実装ファイル**: `app/api/workclock/rewards/route.ts`, `app/api/workclock/rewards/[id]/route.ts`

**保存処理**:
- POST: `prisma.workClockReward.create()` でPostgreSQLに保存
- PUT: `prisma.workClockReward.update()` でPostgreSQLに更新
- DELETE: `prisma.workClockReward.delete()` でPostgreSQLから削除

#### 2.4 報酬プリセット（Reward Presets）

| エンドポイント | メソッド | 実装状況 | PostgreSQL保存 |
|--------------|---------|---------|---------------|
| `/api/workclock/reward-presets` | GET | ✅ | ✅ |
| `/api/workclock/reward-presets` | POST | ✅ | ✅ |
| `/api/workclock/reward-presets` | PUT | ✅ | ✅ |
| `/api/workclock/reward-presets` | DELETE | ✅ | ✅ |

**実装ファイル**: `app/api/workclock/reward-presets/route.ts`

**保存処理**:
- POST: `prisma.workClockRewardPreset.create()` でPostgreSQLに保存
- PUT: `prisma.workClockRewardPreset.update()` でPostgreSQLに更新
- DELETE: `prisma.workClockRewardPreset.delete()` でPostgreSQLから削除

#### 2.5 チーム（Teams）

| エンドポイント | メソッド | 実装状況 | PostgreSQL保存 |
|--------------|---------|---------|---------------|
| `/api/workclock/teams` | GET | ✅ | ✅ |
| `/api/workclock/teams` | POST | ✅ | ✅ |
| `/api/workclock/teams` | DELETE | ✅ | ✅ |

**実装ファイル**: `app/api/workclock/teams/route.ts`

**保存処理**:
- POST: `prisma.workClockTeam.create()` でPostgreSQLに保存
- DELETE: `prisma.workClockTeam.delete()` でPostgreSQLから削除

#### 2.6 消費税設定（Tax Settings）

| エンドポイント | メソッド | 実装状況 | PostgreSQL保存 |
|--------------|---------|---------|---------------|
| `/api/workclock/tax-settings` | GET | ✅ | ✅ |
| `/api/workclock/tax-settings` | PUT | ✅ | ✅ |

**実装ファイル**: `app/api/workclock/tax-settings/route.ts`

**保存処理**:
- PUT: `prisma.masterData.upsert()` でPostgreSQLに保存（標準税率）
- PUT: `prisma.workClockWorker.updateMany()` でPostgreSQLに更新（ワーカー個別税率）

---

## 3. フロントエンド実装状況

### ❌ 問題点：APIを使用していない

**フロントエンドは全てlocalStorageを使用しており、APIエンドポイントを呼び出していません。**

#### 3.1 使用されているストレージ

**ファイル**: `WorkClock/lib/storage.ts`

全ての保存処理がlocalStorageを使用：

```typescript
// Workers
export function saveWorkers(workers: Worker[]): void {
  localStorage.setItem(WORKERS_KEY, JSON.stringify(workers))
}

// Time Entries
export function saveTimeEntries(entries: TimeEntry[]): void {
  localStorage.setItem(ENTRIES_KEY, JSON.stringify(entries))
}

// Teams
export function saveTeams(teams: string[]): void {
  localStorage.setItem(TEAMS_KEY, JSON.stringify(teams))
}
```

#### 3.2 フロントエンドコンポーネントの実装

以下のコンポーネントが`lib/storage.ts`のlocalStorage関数を使用：

1. **`WorkClock/app/page.tsx`**
   - `getWorkers()`, `initializeSampleData()` を使用

2. **`WorkClock/app/worker/[id]/page.tsx`**
   - `getWorkerById()`, `getWorkers()`, `getEntriesByWorkerAndMonth()` を使用

3. **`WorkClock/app/admin/page.tsx`**
   - `getWorkers()`, `getTimeEntries()`, `getWorkerById()`, `getEntriesByWorkerAndMonth()` を使用

4. **`WorkClock/components/time-entry-dialog.tsx`**
   - `addTimeEntry()`, `updateTimeEntry()`, `deleteTimeEntry()` を使用
   - **重要**: このコンポーネントが時間記録の保存を担当しているが、localStorageのみ使用

5. **`WorkClock/components/calendar-view.tsx`**
   - `TimeEntryDialog`を使用（間接的にlocalStorageを使用）

6. **`WorkClock/components/week-view.tsx`**
   - `TimeEntryDialog`を使用（間接的にlocalStorageを使用）

#### 3.3 API呼び出しの有無

**調査結果**: `WorkClock`ディレクトリ内でAPIエンドポイント（`/api/workclock/*`）を呼び出している箇所は**一切ありません**。

```bash
# 検索結果
grep -r "/api/workclock" WorkClock/
# → 結果なし

grep -r "fetch.*workclock" WorkClock/
# → 結果なし
```

---

## 4. 保存箇所の詳細分析

### 4.1 時間記録（Time Entries）の保存

#### 現在の実装
- **保存先**: localStorageのみ
- **保存関数**: `WorkClock/lib/storage.ts` の `addTimeEntry()`, `updateTimeEntry()`, `deleteTimeEntry()`
- **使用箇所**: `WorkClock/components/time-entry-dialog.tsx`

#### 問題点
- PostgreSQLへの保存が行われていない
- ブラウザのlocalStorageにのみ保存されるため、データの永続性が保証されない
- 複数デバイス間でのデータ同期ができない

#### 必要な修正
- `time-entry-dialog.tsx`の`handleAddEntry()`を修正し、`/api/workclock/time-entries`のPOSTを呼び出す
- 更新・削除処理も同様にAPIを呼び出すように修正

### 4.2 ワーカー（Workers）の保存

#### 現在の実装
- **保存先**: localStorageのみ
- **保存関数**: `WorkClock/lib/storage.ts` の `addWorker()`, `updateWorker()`, `deleteWorker()`

#### 問題点
- PostgreSQLへの保存が行われていない
- ワーカー情報がブラウザのlocalStorageにのみ保存される

#### 必要な修正
- ワーカー作成・更新・削除処理で`/api/workclock/workers`のAPIを呼び出すように修正

### 4.3 特別報酬・経費（Rewards）の保存

#### 現在の実装
- **保存先**: 未実装（フロントエンドにRewards管理機能が見当たらない）

#### 問題点
- フロントエンドにRewards管理機能が存在しない
- APIは実装済みだが、フロントエンドから使用されていない

#### 必要な修正
- Rewards管理機能をフロントエンドに実装
- `/api/workclock/rewards`のAPIを呼び出すように実装

### 4.4 報酬プリセット（Reward Presets）の保存

#### 現在の実装
- **保存先**: 未実装（フロントエンドにReward Presets管理機能が見当たらない）

#### 問題点
- フロントエンドにReward Presets管理機能が存在しない
- APIは実装済みだが、フロントエンドから使用されていない

#### 必要な修正
- Reward Presets管理機能をフロントエンドに実装
- `/api/workclock/reward-presets`のAPIを呼び出すように実装

### 4.5 チーム（Teams）の保存

#### 現在の実装
- **保存先**: localStorageのみ
- **保存関数**: `WorkClock/lib/storage.ts` の `addTeam()`, `deleteTeam()`

#### 問題点
- PostgreSQLへの保存が行われていない
- チーム情報がブラウザのlocalStorageにのみ保存される

#### 必要な修正
- チーム作成・削除処理で`/api/workclock/teams`のAPIを呼び出すように修正

### 4.6 消費税設定（Tax Settings）の保存

#### 現在の実装
- **保存先**: 未実装（フロントエンドにTax Settings管理機能が見当たらない）

#### 問題点
- フロントエンドにTax Settings管理機能が存在しない
- APIは実装済みだが、フロントエンドから使用されていない

#### 必要な修正
- Tax Settings管理機能をフロントエンドに実装
- `/api/workclock/tax-settings`のAPIを呼び出すように実装

---

## 5. 影響範囲

### 5.1 データの永続性

- ❌ **現在**: ブラウザのlocalStorageにのみ保存されるため、ブラウザのデータ削除や別デバイスでのアクセス時にデータが失われる
- ✅ **期待**: PostgreSQLに保存されるため、データが永続的に保持される

### 5.2 マルチデバイス対応

- ❌ **現在**: 各デバイスのlocalStorageに個別に保存されるため、デバイス間でデータが同期されない
- ✅ **期待**: PostgreSQLに保存されるため、どのデバイスからでも同じデータにアクセスできる

### 5.3 データの整合性

- ❌ **現在**: 各ブラウザのlocalStorageに個別に保存されるため、データの整合性が保証されない
- ✅ **期待**: PostgreSQLに一元管理されるため、データの整合性が保証される

### 5.4 バックアップ・復元

- ❌ **現在**: localStorageのデータはバックアップが困難
- ✅ **期待**: PostgreSQLのデータは標準的なバックアップ手法でバックアップ可能

---

## 6. 修正が必要な箇所

### 6.1 優先度：高（必須）

1. **時間記録の保存**
   - `WorkClock/components/time-entry-dialog.tsx`
   - `addTimeEntry()`, `updateTimeEntry()`, `deleteTimeEntry()`をAPI呼び出しに変更

2. **ワーカー情報の保存**
   - ワーカー作成・更新・削除処理をAPI呼び出しに変更

3. **データ取得処理**
   - `WorkClock/app/worker/[id]/page.tsx`
   - `WorkClock/app/admin/page.tsx`
   - localStorageから取得する処理をAPI呼び出しに変更

### 6.2 優先度：中

4. **チーム管理機能**
   - チーム作成・削除処理をAPI呼び出しに変更

### 6.3 優先度：低（機能追加）

5. **特別報酬・経費管理機能**
   - フロントエンドにRewards管理機能を実装

6. **報酬プリセット管理機能**
   - フロントエンドにReward Presets管理機能を実装

7. **消費税設定管理機能**
   - フロントエンドにTax Settings管理機能を実装

---

## 7. 推奨される修正手順

### ステップ1: データ取得処理の修正

1. `WorkClock/app/worker/[id]/page.tsx`を修正
   - `getWorkerById()` → `/api/workclock/workers/[id]`のGETを呼び出す
   - `getEntriesByWorkerAndMonth()` → `/api/workclock/time-entries?workerId=...&year=...&month=...`のGETを呼び出す

2. `WorkClock/app/admin/page.tsx`を修正
   - `getWorkers()` → `/api/workclock/workers`のGETを呼び出す
   - `getTimeEntries()` → `/api/workclock/time-entries`のGETを呼び出す

### ステップ2: データ保存処理の修正

1. `WorkClock/components/time-entry-dialog.tsx`を修正
   - `addTimeEntry()` → `/api/workclock/time-entries`のPOSTを呼び出す
   - `updateTimeEntry()` → `/api/workclock/time-entries/[id]`のPUTを呼び出す
   - `deleteTimeEntry()` → `/api/workclock/time-entries/[id]`のDELETEを呼び出す

2. ワーカー管理機能を修正
   - ワーカー作成 → `/api/workclock/workers`のPOSTを呼び出す
   - ワーカー更新 → `/api/workclock/workers/[id]`のPUTを呼び出す
   - ワーカー削除 → `/api/workclock/workers/[id]`のDELETEを呼び出す

### ステップ3: 認証ヘッダーの追加

- 全てのAPI呼び出しに`x-employee-id`ヘッダーを追加する必要があります
- 現在のログイン状態からemployeeIdを取得する仕組みが必要です

### ステップ4: エラーハンドリング

- API呼び出しのエラーハンドリングを実装
- ネットワークエラー時のリトライ処理
- ユーザーへのエラーメッセージ表示

### ステップ5: ローカルストレージからの移行

- 既存のlocalStorageデータをPostgreSQLに移行するスクリプトを作成
- 移行後、localStorageの使用を停止

---

## 8. 結論

### 現状

- ✅ **APIエンドポイント**: 全て実装済みで、PostgreSQLへの保存処理が正しく実装されている
- ❌ **フロントエンド**: 全てlocalStorageを使用しており、APIを一切使用していない
- ❌ **データ永続化**: PostgreSQLへの保存が行われていない

### 必要な対応

1. **フロントエンドの修正**: localStorageの使用をやめ、APIエンドポイントを呼び出すように修正
2. **認証の実装**: API呼び出しに必要な認証ヘッダーを追加
3. **データ移行**: 既存のlocalStorageデータをPostgreSQLに移行

### 優先度

- **最優先**: 時間記録の保存・取得処理の修正（最も重要な機能）
- **高**: ワーカー情報の保存・取得処理の修正
- **中**: その他の機能の修正

---

## 9. 補足情報

### 9.1 実装済みAPIの詳細

全てのAPIエンドポイントは以下の機能を実装しています：

- ✅ 認証チェック（`x-employee-id`ヘッダー）
- ✅ 権限チェック（ロールベース）
- ✅ バリデーション
- ✅ エラーハンドリング
- ✅ PostgreSQLへの保存・更新・削除

### 9.2 フロントエンドの現状

- `WorkClock/lib/storage.ts`が全てのデータ操作をlocalStorageで実装
- フロントエンドコンポーネントは全てこの`storage.ts`を使用
- APIを呼び出すコードが一切存在しない

### 9.3 推奨されるアーキテクチャ

```
フロントエンド
  ↓ API呼び出し
APIエンドポイント
  ↓ Prisma
PostgreSQL
```

現在の実装は以下のようになっています：

```
フロントエンド
  ↓ localStorage
ブラウザのlocalStorage
```

---

**調査完了日**: 2025年1月  
**調査者**: AI Assistant  
**次回アクション**: フロントエンドの修正実装











