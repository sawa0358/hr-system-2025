# 有給管理のLIFO形式と失効処理の説明

## 具体例で説明

### シナリオ: 社員Aの有給管理

**社員Aの情報:**
- 入社日: 2023年1月1日
- 有効期限設定: 2年（基本設定から取得）
- 付与サイクル: 毎年1月1日

### 現在の状態（2025年11月1日時点）

#### 付与ロットの履歴

1. **2023年1月1日付与**
   - 付与日数: 10日
   - 有効期限: 2024年12月31日（付与日から2年後の前日）
   - **状態**: ✗ **期限切れ（失効済み）**
   - 残日数: 0日（失効処理により0になった）

2. **2024年1月1日付与**
   - 付与日数: 11日
   - 有効期限: 2025年12月31日（付与日から2年後の前日）
   - **状態**: ✓ **有効（あと61日）**
   - 残日数: 5日
   - 使用済み: 6日（2024年中に消費）

3. **2025年1月1日付与**
   - 付与日数: 12日
   - 有効期限: 2026年12月31日（付与日から2年後の前日）
   - **状態**: ✓ **有効（あと426日）**
   - 残日数: 12日
   - 使用済み: 0日

#### 現在の有給残高

- **総残日数**: 17日（5日 + 12日）
  - 2024年付与: 5日
  - 2025年付与: 12日

### LIFO形式での消化の流れ

#### 例: 3日の有給を申請する場合

**消化順序（新しい方から）:**

1. **2025年1月1日付与のロットから 3日を消費**
   - 残日数: 12日 → 9日
   - 2024年付与のロットは触らない

**結果:**
- 2025年付与: 12日 → **9日**（3日消費）
- 2024年付与: 5日 → **5日**（変化なし）
- **総残日数**: 17日 → **14日**

#### 例: さらに8日の有給を申請する場合

**消化順序:**

1. **2025年1月1日付与のロットから 8日を消費**
   - 残日数: 9日 → 1日

**結果:**
- 2025年付与: 9日 → **1日**（8日消費）
- 2024年付与: 5日 → **5日**（変化なし）
- **総残日数**: 14日 → **6日**

#### 例: さらに7日の有給を申請する場合

**消化順序:**

1. **2025年1月1日付与のロットから 1日を消費**（残り1日分）
   - 残日数: 1日 → 0日

2. **2024年1月1日付与のロットから 6日を消費**（残り6日必要）
   - 残日数: 5日 → 0日（不足: 1日）

**結果:**
- 2025年付与: 1日 → **0日**（1日消費）
- 2024年付与: 5日 → **0日**（5日消費、1日不足）
- **総残日数**: 6日 → **1日不足**

※ 実際には残日数不足エラーになる

### 失効処理の例

#### 2025年12月31日が過ぎた場合（2026年1月1日）

**失効処理が実行される:**

1. **2024年1月1日付与のロット**
   - 有効期限: 2025年12月31日
   - **2026年1月1日時点で期限切れ**
   - 残日数: 5日 → **0日**（失効処理により自動的に0になる）

**結果:**
- 2024年付与: 5日 → **0日**（失効）
- 2025年付与: 12日 → **12日**（変化なし）
- **総残日数**: 17日 → **12日**

### 新付与の例

#### 2026年1月1日（次回付与日）

**新付与が実行される:**

1. **新規ロット作成: 2026年1月1日付与**
   - 付与日数: 13日（勤続3.5年で13日）
   - 有効期限: 2027年12月31日（付与日から2年後の前日）
   - **状態**: ✓ **有効**
   - 残日数: 13日

**結果（付与直後）:**
- 2026年付与: **13日**（新規）
- 2025年付与: 12日（変化なし）
- 2024年付与: 0日（失効済み）
- **総残日数**: 12日 → **25日**

### LIFO形式の特徴

#### ✅ 正しい動作

1. **新しいロットから優先的に消費**
   - 2025年付与が残っている限り、2024年付与は消費されない
   - 2025年付与を使い切ってから、2024年付与が消費される

2. **失効は古いロットから**
   - 2024年付与が先に失効する
   - 2025年付与はまだ有効

3. **新付与は最新ロットとして追加**
   - 2026年付与が最優先で消費される
   - 次に2025年付与、その次に2024年付与

#### 現在の実装での確認事項

**1. LIFO形式で消化されているか？**
- ✅ `consumeLIFO`関数で`grantDate`降順で取得
- ✅ 新しいロットから順に消費

**2. 有効期限が設定通りに適用されているか？**
- ✅ `computeExpiry`関数で設定から有効期限を計算
- ✅ 付与日から2年後の前日まで有効

**3. 失効処理が実行されているか？**
- ✗ **失効処理が実行されていないロットが存在**（5件確認）
- ✅ 失効処理APIを作成済み（`/api/vacation/expire`）

**4. 新付与が自動実行されているか？**
- ✗ **自動実行の設定がない**
- ✅ 自動付与APIを作成済み（`/api/vacation/grant/auto`）

## 認識の確認

### 質問: 認識は合っていますか？

1. **現在17日残有給がある**
   - 古い有給（2024年付与）: 5日
   - 新しい有給（2025年付与）: 12日
   - **✓ 合っています**

2. **新しい方から消化している**
   - 3日申請 → 2025年付与から消費
   - 8日申請 → 2025年付与から消費
   - 2025年付与を使い切ってから2024年付与を消費
   - **✓ LIFO形式で実装されています**

3. **失効のタイミング**
   - 2024年付与: 2025年12月31日が有効期限
   - **2026年1月1日0:00に失効処理が実行されると、2024年付与の残日数が0になる**
   - **✓ 合っています**

4. **新付与のタイミング**
   - 2026年1月1日が次回付与日
   - **2026年1月1日0:00に新付与が実行されると、13日が追加される**
   - **✓ 合っています**

### 現在の実装での動作タイミング

**失効処理:**
- 現在: 手動実行のみ（APIエンドポイントあり）
- 推奨: 毎日0:00に自動実行（cron等）

**新付与:**
- 現在: 手動実行のみ（APIエンドポイントあり）
- 推奨: 毎日23:59に自動実行して、翌日が付与日の社員に対してロットを生成

## まとめ

**認識は正しいです。** ただし、現在は自動実行が設定されていないため、手動で実行する必要があります。

