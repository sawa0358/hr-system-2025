# 有給管理のログ取得機能 実装設計

## 要件

1. 新しく有給付与される直前の状態（新付与日の前日23:59時点）の社員が見る有給画面を画像として保存
2. 新しく有給付与されるのは新付与日の0:00であるかどうか確認 → **確認済み（現在は0:00に付与されていない）**
3. PDFでDLできるようにする
4. 設定内の「勤続年数別付与日数（正社員）」「パート・アルバイト用付与日数表」のテーブルの勤続年数に準じて、確認したいログの勤続年数プルダウンを出し、選ぶと表示されるようにする
5. プルダウン期間「0.5〜1.5年」「1.5~2.5年」「2.5〜3.5年」・・・・・・・

## 実装ステップ

### ステップ1: データベーススキーマ設計

#### VacationLog テーブル
```prisma
model VacationLog {
  id              String   @id @default(cuid())
  employeeId      String
  employee        Employee @relation(fields: [employeeId], references: [id])
  
  // ログ取得時の情報
  snapshotDate    DateTime  // スナップショット取得日時（付与前日23:59）
  grantDate       DateTime  // このログに関連する付与日
  yearsOfService  Decimal   // 勤続年数（0.5刻み）
  yearsRange      String    // 勤続年数範囲（例: "0.5〜1.5年"）
  
  // スナップショットデータ
  totalGranted    Decimal   // 総付与数
  totalRemaining  Decimal   // 残り有給日数
  used            Decimal   // 取得済み日数
  pending         Decimal   // 申請中日数
  
  // 画面キャプチャ
  screenshotPath  String?   // 画像ファイルパス
  screenshotUrl   String?   // 画像URL（S3等）
  
  // メタデータ
  createdAt       DateTime  @default(now())
  
  @@index([employeeId])
  @@index([grantDate])
  @@index([yearsOfService])
  @@map("vacation_logs")
}
```

### ステップ2: ログ取得スケジュール機能

#### バッチ処理（cron等）
- 毎日23:59に実行
- 翌日が付与日である社員を特定
- 各社員の有給画面をキャプチャ
- VacationLogに保存

### ステップ3: スクリーンショット取得機能

#### Puppeteer等を使用
- ヘッドレスブラウザで有給画面をレンダリング
- 画面キャプチャを取得
- 画像として保存（S3等）

### ステップ4: PDF生成機能

#### PDF生成ライブラリ（PDFKit, jsPDF等）
- ログ一覧からPDFを生成
- 画像をPDFに埋め込み
- 勤続年数範囲ごとにセクション分け

### ステップ5: UI実装

#### ログ一覧ページ
- 勤続年数範囲プルダウン
- 選択した範囲のログを表示
- PDFダウンロードボタン

## 技術スタック候補

- **スクリーンショット**: Puppeteer, Playwright
- **PDF生成**: PDFKit, jsPDF, Puppeteer（PDF出力）
- **画像保存**: ローカルストレージ / S3
- **スケジューラー**: node-cron, Vercel Cron

## 実装順序

1. ✅ 有給付与タイミング確認スクリプト
2. データベーススキーマ追加（VacationLog）
3. ログ取得API実装（手動実行用）
4. スクリーンショット取得機能実装
5. ログ一覧表示UI実装
6. 勤続年数範囲フィルター実装
7. PDF生成機能実装
8. バッチ処理実装（自動実行）

