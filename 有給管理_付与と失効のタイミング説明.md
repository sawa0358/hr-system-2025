# 有給管理 付与と失効のタイミング説明

## 質問への回答

### Q1: 有給の新付与は当日何時？

**A: 付与日の0:00（UTC）または前日23:59（UTC）に実行**

現在の実装では、2つの選択肢があります：

#### パターン1: 付与日当日0:00（UTC）に実行（推奨）
- **実行タイミング**: 毎日 0:00（UTC）
- **処理内容**: 当日が付与日の社員に対してロットを生成
- **実装**: `/api/cron/grant`を0:00（UTC）に実行するようにcronを設定

#### パターン2: 付与日前日23:59（UTC）に実行
- **実行タイミング**: 毎日 23:59（UTC）
- **処理内容**: 翌日が付与日の社員に対してロットを生成
- **実装**: `/api/cron/grant`を23:59（UTC）に実行するようにcronを設定

**現在のコード実装**:
- `getNextGrantDate`で翌日が付与日かをチェック
- 翌日が付与日の場合、ロットを生成

**推奨設定**:
- **付与日当日0:00（UTC）実行**: `0 0 * * *` (毎日 0:00 UTC = 日本時間 9:00)
- **付与日前日23:59（UTC）実行**: `59 23 * * *` (毎日 23:59 UTC = 日本時間 8:59)

### Q2: 2年前に付与された残有休日数は、新付与日前日に失効？何時？

**A: 有効期限（expiryDate）の翌日0:00（UTC）に失効処理が実行される**

#### 有効期限の計算
- 設定: 有効期限は2年（基本設定から取得、変更可能）
- 計算式: `付与日 + 2年 - 1日`
- 例: 2023年1月1日付与 → 有効期限は2024年12月31日

#### 失効処理のタイミング
- **実行タイミング**: 毎日 0:00（UTC）
- **判定条件**: `expiryDate < today`
- **処理内容**: 有効期限を過ぎたロットの残日数を0にする

#### 具体例

**社員A（入社日: 2022年1月1日）の場合**:

1. **2022年7月1日付与（0.5年）**
   - 付与日数: 10日
   - 有効期限: 2024年6月30日（付与日から2年後 - 1日）
   - 失効タイミング: **2024年7月1日 0:00（UTC）**に失効処理で0になる

2. **2023年7月1日付与（1.5年）**
   - 付与日数: 11日
   - 有効期限: 2025年6月30日（付与日から2年後 - 1日）
   - 失効タイミング: **2025年7月1日 0:00（UTC）**に失効処理で0になる

3. **2024年7月1日付与（2.5年）**
   - 付与日数: 12日
   - 有効期限: 2026年6月30日（付与日から2年後 - 1日）
   - 失効タイミング: **2026年7月1日 0:00（UTC）**に失効処理で0になる

#### 重要なポイント

1. **失効処理は有効期限の翌日0:00に実行される**
   - 有効期限が2024年12月31日の場合、2025年1月1日 0:00（UTC）に失効処理で0になる

2. **新付与と失効処理の実行順序**
   - **パターン1（推奨）**: 付与日当日0:00（UTC）実行
     - 同じ日に新付与と失効処理が実行される場合、実行順序は設定による（通常は失効処理→新付与の順）
   - **パターン2**: 付与日前日23:59（UTC）実行
     - 新付与が先に実行され、失効処理は翌日0:00に実行される

## タイムゾーンの注意

- すべての時刻はUTCで処理されます
- 日本時間（JST）で考える場合：
  - 0:00（UTC） = 9:00（JST）
  - 23:59（UTC） = 8:59（JST）

## 実装コード

### 失効処理（`expireGrantLots`関数）

```typescript
export async function expireGrantLots(today: Date = new Date()): Promise<number> {
  const result = await prisma.grantLot.updateMany({
    where: {
      expiryDate: { lt: today }, // 有効期限が今日より前
      daysRemaining: { gt: 0 },  // 残日数が0より大きい
    },
    data: {
      daysRemaining: 0,
    },
  });

  return result.count;
}
```

### 有効期限の計算（`computeExpiry`関数）

```typescript
export function computeExpiry(grantDate: Date, rule: ExpiryRule): Date {
  switch (rule.kind) {
    case 'YEARS':
      return addDays(addYears(grantDate, rule.years), -1); // 2年後の前日
    // ...
  }
}
```

## まとめ

- **新付与**: 付与日当日0:00（UTC）または前日23:59（UTC）に実行（設定による）
- **失効処理**: 有効期限の翌日0:00（UTC）に実行
  - 有効期限が2024年12月31日の場合 → 2025年1月1日 0:00（UTC）に失効
  - 新付与日前日ではなく、有効期限の翌日に失効

