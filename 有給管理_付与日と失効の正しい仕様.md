# 有給管理の付与日と失効の正しい仕様

## 正しい仕様（ユーザー要求）

### 付与のタイミング
- **初回付与**: 入社から0.5年（6ヶ月後）
- **2回目付与**: 入社から1.5年（初回付与から1年後）
- **3回目付与**: 入社から2.5年（2回目付与から1年後）
- ...以降も同様に、入社から0.5年刻みで付与

### 失効のタイミング
- **0.5年付与分**: 1.5年付与の前日まで有効（つまり、1.5年付与日-1日まで）
- **1.5年付与分**: 2.5年付与の前日まで有効（つまり、2.5年付与日-1日まで）
- **2.5年付与分**: 3.5年付与の前日まで有効（つまり、3.5年付与日-1日まで）
- ...以降も同様に、次回付与日の前日まで有効

## 現在の実装の問題点

### ✅ 実装されている部分
1. **各社員の入社日を基準に付与日を計算**
   - ✓ `iterateAnchors`関数で入社日を基準に付与日を生成
   - ✓ 各社員で異なる付与日になる

2. **0.5年刻みで付与**
   - ✓ 初回: 0.5年（6ヶ月後）
   - ✓ 2回目: 1.5年（12ヶ月後）
   - ✓ 3回目: 2.5年（さらに12ヶ月後）

### ✗ 実装されていない部分
**有効期限の計算が間違っている**

**現在の実装:**
- 有効期限 = 付与日から2年後（固定）

**正しい仕様:**
- 有効期限 = 次回付与日の前日
  - 0.5年付与 → 1.5年付与日の前日まで
  - 1.5年付与 → 2.5年付与日の前日まで
  - 2.5年付与 → 3.5年付与日の前日まで

## 具体例

### 社員B（入社日: 2022年1月1日）の場合

#### 付与履歴

1. **2022年7月1日付与（入社から0.5年）**
   - 付与日数: 10日
   - **有効期限**: 2023年6月30日（1.5年付与日の前日）
   - 失効タイミング: 2023年7月1日（1.5年付与日）に失効処理で0になる

2. **2023年7月1日付与（入社から1.5年）**
   - 付与日数: 11日
   - **有効期限**: 2024年6月30日（2.5年付与日の前日）
   - 失効タイミング: 2024年7月1日（2.5年付与日）に失効処理で0になる

3. **2024年7月1日付与（入社から2.5年）**
   - 付与日数: 12日
   - **有効期限**: 2025年6月30日（3.5年付与日の前日）
   - 失効タイミング: 2025年7月1日（3.5年付与日）に失効処理で0になる

## 修正が必要な箇所

### 1. `computeExpiry`関数の修正
現在: 付与日から固定年数（2年）
修正後: 次回付与日の前日

### 2. `generateGrantLotsForEmployee`関数の修正
次回付与日を計算して、それを有効期限として使用

