# 有給管理：初期設定投入と全社員付与ロット生成の説明

## 概要

有給管理システムを初回セットアップする際に使用する2つの機能について説明します。

---

## 1. 初期設定投入

### 機能の説明

**初期設定投入**は、有給管理システムのデフォルト設定をデータベースに保存し、有効化する機能です。

### 実行タイミング

- **初回セットアップ時**に1回だけ実行
- 既にアクティブな設定がある場合は実行できません（エラーが表示されます）

### 実行場所

**管理者画面**（`/leave/admin`）の右上に「初期設定投入」ボタンがあります。

### 処理内容

1. **既存のアクティブ設定を確認**
   - 既にアクティブな設定がある場合は、エラーを返します
   - これにより、意図しない上書きを防ぎます

2. **デフォルト設定を保存**
   - `DEFAULT_APP_CONFIG` の内容をデータベースに保存します
   - バージョン: `1.0.0`

3. **デフォルト設定を有効化**
   - 保存した設定を `isActive: true` に設定
   - 既存のアクティブ設定は `isActive: false` に変更

### デフォルト設定の内容

```typescript
- バージョン: '1.0.0'
- 付与基準ルール: 入社日から6ヶ月後に初回付与、以降12ヶ月ごと
- 失効ルール: 付与から2年後まで有効
- 丸めルール: 日単位、四捨五入
- 正社員（パターンA）付与テーブル:
  - 0.5年: 10日
  - 1.5年: 11日
  - 2.5年: 12日
  - 3.5年: 14日
  - 4.5年: 16日
  - 5.5年: 18日
  - 6.5年: 20日
- パート・アルバイト付与テーブル（週1〜4日勤務用）:
  - 各パターンごとに勤続年数に応じた付与日数を設定
```

### 注意事項

- **既にアクティブな設定がある場合は実行できません**
- 設定画面（`/leave/settings`）で設定をカスタマイズした場合は、この機能は使用しません
- この機能は主に**初回セットアップ時**のみ使用します

### 実装ファイル

- **API**: `app/api/vacation/config/init/route.ts`
- **UI**: `app/leave/admin/page.tsx`（「初期設定投入」ボタン）
- **設定定義**: `lib/vacation-config.ts`（`DEFAULT_APP_CONFIG`）

---

## 2. 全社員付与ロット生成

### 機能の説明

**全社員付与ロット生成**は、全社員の有給付与ロット（GrantLot）を一括生成・更新する機能です。

### 実行タイミング

- **初回セットアップ時**（初期設定投入後）
- **設定変更後**（新しい設定バージョンを適用した後）
- **定期的な再計算が必要な場合**

### 実行場所

**管理者画面**（`/leave/admin`）の右上に「全社員付与ロット生成」ボタンがあります。

### 処理内容

1. **全社員を取得**
   - ステータスが `active`（在籍中）の社員のみを対象
   - コピー社員（`status: 'copy'`）は除外

2. **各社員の付与ロットを生成**
   - 各社員に対して `generateGrantLotsForEmployee()` を実行
   - 以下の情報を基にロットを生成:
     - 入社日（`joinDate`）
     - 雇用形態（`employmentType`）
     - 週間勤務パターン（`weeklyPattern`）
     - 有給計算パターン（`vacationPattern`）
     - 設定バージョン（`configVersion`）

3. **結果を集計**
   - 生成されたロット数（`generated`）
   - 更新されたロット数（`updated`）
   - 成功/失敗の統計情報

### 付与ロット生成のロジック

各社員に対して、以下の基準日（Anchor）ごとにロットを生成します：

1. **付与基準日を計算**
   - 入社日から6ヶ月後が初回付与日
   - 以降、設定されたサイクル（通常12ヶ月）ごとに付与基準日を計算

2. **勤続年数に応じた付与日数を決定**
   - 正社員: パターンAの付与テーブルから勤続年数に応じた日数を取得
   - パート・アルバイト: 週間勤務パターン（1〜4日）と勤続年数に応じた日数を取得

3. **ロットを生成または更新**
   - 既存のロットがある場合は更新（設定バージョンが異なる場合は既存ロットを無効化）
   - 新規のロットがない場合は作成

4. **失効日を計算**
   - 設定された失効ルール（通常2年）に基づいて `expiryDate` を設定

### 実行前の確認

実行前に確認ダイアログが表示されます：
```
全社員の付与ロットを生成しますか？
既存のロットがある場合は更新されます。
```

### 実行結果の表示

成功すると、以下の情報がトースト通知で表示されます：
```
付与ロット生成完了
成功: X件、生成: Y件、更新: Z件
```

### 注意事項

- **実行には時間がかかる場合があります**（社員数が多い場合）
- **既存のロットが更新される可能性があります**
- **エラーが発生した社員は結果に含まれますが、個別にエラーログが記録されます**

### 実装ファイル

- **API**: `app/api/vacation/recalc/all/route.ts`
- **UI**: `app/leave/admin/page.tsx`（「全社員付与ロット生成」ボタン）
- **ロット生成ロジック**: `lib/vacation-lot-generator.ts`（`generateGrantLotsForAllEmployees`）

---

## 実行順序

有給管理システムを初回セットアップする場合の推奨順序：

1. **初期設定投入**
   - デフォルト設定をデータベースに保存し、有効化

2. **全社員付与ロット生成**
   - 全社員の有給付与ロットを一括生成

3. **必要に応じて設定をカスタマイズ**
   - 設定画面（`/leave/settings`）で設定を変更
   - 新しい設定を有効化

4. **再度、全社員付与ロット生成**
   - 新しい設定に基づいてロットを再生成

---

## よくある質問

### Q1: 初期設定投入を複数回実行できますか？

A: いいえ。既にアクティブな設定がある場合は実行できません。設定を変更したい場合は、設定画面（`/leave/settings`）で新しい設定を保存・有効化してください。

### Q2: 全社員付与ロット生成は既存のロットを削除しますか？

A: いいえ。既存のロットは更新されます（設定バージョンが異なる場合は無効化）。新しいロットのみが生成されます。

### Q3: 特定の社員だけのロットを生成できますか？

A: 現在の実装では、全社員一括生成のみ対応しています。個別の社員のロットを生成したい場合は、別途実装が必要です。

### Q4: 実行中にエラーが発生した場合、他の社員のロット生成は続行されますか？

A: はい。各社員のロット生成は個別に処理されるため、1人の社員でエラーが発生しても、他の社員の処理は続行されます。

---

## まとめ

- **初期設定投入**: 初回セットアップ時にデフォルト設定を有効化
- **全社員付与ロット生成**: 全社員の有給付与ロットを一括生成・更新
- 両方の機能は管理者画面（`/leave/admin`）から実行できます
- 実行順序は「初期設定投入」→「全社員付与ロット生成」が推奨されます

