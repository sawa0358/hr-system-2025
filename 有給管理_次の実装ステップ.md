# 有給管理システム 次の実装ステップ案

## 📊 現在の実装状況

### ✅ 実装済み
1. **Prismaスキーマ拡張**
   - GrantLot, Consumption, TimeOffRequest, AlertEvent, AuditLog, VacationAppConfig
   - EmployeeモデルにvacationPattern, weeklyPattern, configVersion追加

2. **コアライブラリ**
   - 付与ロット計算ロジック（基準日生成、付与日数計算）
   - LIFO消化ロジック
   - 残日数・表示算出ロジック
   - パターン値判定ロジック

3. **APIエンドポイント**
   - `/api/vacation/stats/[employeeId]` - 統計情報取得
   - `/api/vacation/admin/applicants` - 管理者用社員一覧
   - `/api/vacation/config` - 設定保存・読み込み
   - `/api/vacation/employee/[employeeId]/pattern` - パターン値設定
   - `/api/vacation/requests/[id]/approve` - 申請承認

4. **UIコンポーネント**
   - VacationStats（統計カード表示）
   - VacationList（申請一覧）
   - VacationRequestForm（申請フォーム）
   - VacationPatternSelector（パターン選択）

### ⚠️ 未実装・改善が必要
1. **データベースマイグレーション** - 新しいテーブルが作成されていない
2. **設定画面の保存機能** - UIはあるが、AppConfig保存機能が未実装
3. **申請フォームの新システム対応** - 旧システム（VacationRequest）を使用中
4. **承認機能のUI連携** - APIは実装済みだが、UIから呼び出されていない
5. **バッチ処理** - 毎日0時の付与判定、失効処理、アラート評価
6. **アラート評価機能** - ロジックは設計済みだが実装されていない

---

## 🎯 次の実装ステップ（優先順位順）

### フェーズ1: 基盤整備（最優先）

#### 1-1. データベースマイグレーション実行 ⭐⭐⭐
**優先度: 最高**
- **作業内容**: 
  - バックアップ作成
  - マイグレーションファイル作成・実行
  - Prismaクライアント再生成
- **影響**: これがないと新しい機能が動作しない
- **所要時間**: 30分〜1時間
- **リスク**: 既存データへの影響（バックアップ必須）

```bash
# バックアップ
cp prisma/dev.db prisma/dev.db.backup

# マイグレーション
npx prisma migrate dev --name add_vacation_lot_system
```

#### 1-2. 設定画面の保存機能実装 ⭐⭐⭐
**優先度: 高**
- **作業内容**:
  - `/leave/settings` の保存ボタンにAppConfig保存機能を実装
  - 設定のバリデーション
  - 設定バージョン管理
- **影響**: 管理者が有給設定を変更できるようにする
- **所要時間**: 2-3時間
- **実装箇所**: 
  - `app/leave/settings/page.tsx` - 保存処理追加
  - `app/api/vacation/config/route.ts` - 既にAPI実装済み

#### 1-3. 初期設定の投入 ⭐⭐
**優先度: 中**
- **作業内容**:
  - デフォルトAppConfigをデータベースに保存・有効化
  - または、設定画面から初期設定を保存できるようにする
- **影響**: システムの初期状態を整える
- **所要時間**: 1時間

---

### フェーズ2: データ生成（優先度: 高）

#### 2-1. 既存社員への付与ロット生成 ⭐⭐⭐
**優先度: 高**
- **作業内容**:
  - `generateGrantLotsForAllEmployees()` を実行するAPI作成
  - 管理者画面から一括実行できるボタンを追加
  - または、マイグレーション時に自動実行
- **影響**: 既存社員の有給ロットが作成され、正しい残日数が表示される
- **所要時間**: 2-3時間
- **実装箇所**:
  - `app/api/vacation/recalc/all/route.ts` - 新規作成
  - または既存の `app/api/vacation/recalc/[employeeId]/route.ts` を拡張

#### 2-2. 社員ごとのパターン値初期設定 ⭐⭐
**優先度: 中**
- **作業内容**:
  - 雇用形態（employeeType）から自動でパターン値を設定
  - 正社員・契約社員・派遣社員 → パターンA
  - パート → 管理者画面から手動設定が必要（B-1〜B-4）
- **影響**: 各社員の有給計算が正しく行われる
- **所要時間**: 1-2時間

---

### フェーズ3: 申請・承認フロー（優先度: 中）

#### 3-1. 申請フォームの新システム対応 ⭐⭐
**優先度: 中**
- **作業内容**:
  - `VacationRequestForm` を `TimeOffRequest` に対応
  - 時間休（HOUR単位）の入力対応
  - 申請時に日数計算（時間→日換算）
- **影響**: 新規申請が正しく保存される
- **所要時間**: 3-4時間
- **実装箇所**:
  - `yukyu-system/components/vacation-request-form.tsx`
  - `app/api/vacation/request/route.ts` - 新システム対応

#### 3-2. 承認機能のUI実装 ⭐⭐
**優先度: 中**
- **作業内容**:
  - `VacationList` の承認ボタンから承認APIを呼び出し
  - 承認結果の表示
  - 却下機能の実装
- **影響**: 管理者が申請を承認できるようになる
- **所要時間**: 2-3時間
- **実装箇所**:
  - `yukyu-system/components/vacation-list.tsx`

---

### フェーズ4: 自動化・バッチ処理（優先度: 低〜中）

#### 4-1. バッチ処理の実装 ⭐
**優先度: 低（将来の拡張）**
- **作業内容**:
  - 毎日0時に実行するバッチ処理
  - 新規付与判定（本日が付与日かチェック）
  - 失効処理（expiry < today のロットを0化）
  - アラート評価
- **影響**: 自動でロット生成・失効処理が行われる
- **所要時間**: 4-6時間
- **実装方法の選択肢**:
  1. Next.js API Route + cron job（Vercel Cronなど）
  2. サーバーサイドのcron job
  3. 手動実行用のAPI + 管理者画面から実行

#### 4-2. アラート評価機能 ⭐
**優先度: 低**
- **作業内容**:
  - 設計メモに基づくアラート評価ロジック実装
  - アラート表示UI
  - アラート通知機能（任意）
- **影響**: 消化不足の社員にアラートを表示
- **所要時間**: 4-5時間

---

## 📝 推奨実装順序

### 最短ルート（即座に動作させる）
1. **データベースマイグレーション実行** ← まずこれ！
2. **設定画面の保存機能実装**
3. **初期設定投入**
4. **既存社員への付与ロット生成**
5. **申請フォームの新システム対応**

### 完全実装ルート（本番運用に向けて）
1. フェーズ1: 基盤整備（1-1, 1-2, 1-3）
2. フェーズ2: データ生成（2-1, 2-2）
3. フェーズ3: 申請・承認フロー（3-1, 3-2）
4. フェーズ4: 自動化（4-1, 4-2）

---

## 🔧 技術的な実装ポイント

### マイグレーション実行時の注意点
- **既存データのバックアップ必須**
- `vacationPattern`など新カラムはnullableなので既存データに影響なし
- 新テーブル（grant_lots等）は空で作成される

### 設定保存の実装例
```typescript
// app/leave/settings/page.tsx
const handleSave = async () => {
  const config: AppConfig = {
    version: `1.0.${Date.now()}`,
    baselineRule: { kind: 'RELATIVE_FROM_JOIN', ... },
    // ... 設定値を構築
  }
  
  await fetch('/api/vacation/config', {
    method: 'POST',
    body: JSON.stringify(config),
  })
  
  // 有効化
  await fetch('/api/vacation/config', {
    method: 'PUT',
    body: JSON.stringify({ version: config.version }),
  })
}
```

### ロット生成の実装例
```typescript
// app/api/vacation/recalc/all/route.ts
export async function POST() {
  const results = await generateGrantLotsForAllEmployees()
  return NextResponse.json({ results })
}
```

---

## 💡 推奨アクション

**今すぐ実行すべきこと:**
1. ✅ データベースマイグレーションの準備（バックアップ）
2. ✅ 設定画面の保存機能実装

**次のセッションで実装:**
3. 初期設定投入とロット生成
4. 申請フォームの新システム対応

