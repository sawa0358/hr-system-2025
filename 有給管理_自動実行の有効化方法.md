# 有給管理 自動実行の有効化方法

## 概要

有給管理システムの自動実行機能は、設定画面から「初期設定投入（反映）」ボタンを押すことで有効化の準備が完了します。実際の自動実行は、外部のcronサービスで設定する必要があります。

## 自動実行の有効化手順

### ステップ1: 設定画面で設定を保存

1. `/leave/settings` にアクセス
2. 有給休暇の設定を入力
3. 「保存」ボタンをクリック（設定を保存するが、まだ反映されない）

### ステップ2: 初期設定投入（反映）

1. 「初期設定投入（反映）」ボタンをクリック
2. 管理者パスワードを入力
3. 設定が有効化される

**この時点で自動実行の準備は完了しています。**

### ステップ3: 外部のcronサービスで自動実行を設定

「初期設定投入（反映）」ボタンを押しただけでは、自動実行は開始されません。実際の自動実行を開始するには、使用しているプラットフォームでcronサービスを設定する必要があります。

#### Herokuの場合

```bash
# 1. Heroku Schedulerを追加
heroku addons:create scheduler:standard

# 2. Heroku DashboardでSchedulerを開き、以下のジョブを追加:
# - 失効処理: curl -X GET "https://your-app.herokuapp.com/api/cron/expire?token=$CRON_SECRET_TOKEN" (毎日0:00 UTC)
# - 自動付与: curl -X GET "https://your-app.herokuapp.com/api/cron/grant?token=$CRON_SECRET_TOKEN" (毎日23:59 UTC)

# 3. 環境変数を設定
heroku config:set CRON_SECRET_TOKEN=your-secret-token-here
```

#### Vercelの場合

`vercel.json`に以下を追加：

```json
{
  "crons": [
    {
      "path": "/api/cron/expire",
      "schedule": "0 0 * * *"
    },
    {
      "path": "/api/cron/grant",
      "schedule": "59 23 * * *"
    }
  ]
}
```

## 重要なポイント

1. **設定画面の「初期設定投入（反映）」ボタンは、設定を有効化するだけで、自動実行は開始しません**
2. **自動実行を開始するには、外部のcronサービス（Heroku Scheduler、Vercel Cron等）で設定する必要があります**
3. **環境変数 `CRON_SECRET_TOKEN` を設定することで、認証保護された自動実行が可能になります**

## トラブルシューティング

### 自動実行が動作しない場合

1. **cronサービスが設定されているか確認**
   - Heroku Schedulerが追加されているか
   - Vercel Cronが設定されているか

2. **環境変数が設定されているか確認**
   ```bash
   # Herokuの場合
   heroku config:get CRON_SECRET_TOKEN
   
   # 設定されていない場合
   heroku config:set CRON_SECRET_TOKEN=your-secret-token-here
   ```

3. **APIエンドポイントが正常に動作するか確認**
   ```bash
   # 手動でテスト実行
   curl -X GET "https://your-app.herokuapp.com/api/cron/expire?token=your-secret-token"
   curl -X GET "https://your-app.herokuapp.com/api/cron/grant?token=your-secret-token"
   ```

## まとめ

- ✅ 設定画面から「初期設定投入（反映）」で設定は有効化される
- ⚠️ 自動実行を開始するには、外部のcronサービスで追加設定が必要
- 📝 詳細は `有給管理_自動実行設定ガイド.md` を参照

