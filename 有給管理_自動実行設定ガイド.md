# 有給管理 自動実行設定ガイド

## 概要

有給管理システムの自動実行機能（失効処理と自動付与）を設定するためのガイドです。

## APIエンドポイント

### 1. 失効処理
- **エンドポイント**: `/api/cron/expire`
- **推奨実行タイミング**: 毎日 0:00（UTC）
- **機能**: 期限切れのロットの残日数を0にする

### 2. 自動付与処理
- **エンドポイント**: `/api/cron/grant`
- **推奨実行タイミング**: 毎日 23:59（UTC）または 0:00（UTC）
  - 23:59実行の場合: 翌日が付与日の社員に対してロットを生成（付与日の前日に実行）
  - 0:00実行の場合: 当日が付与日の社員に対してロットを生成（付与日当日に実行）
- **機能**: 翌日（または当日）が付与日の社員に対してロットを自動生成

## 認証設定

環境変数で認証トークンを設定します：

```bash
CRON_SECRET_TOKEN=your-secret-token-here
```

### 認証方法

1. **Authorization ヘッダー**:
   ```
   Authorization: Bearer your-secret-token-here
   ```

2. **Query Parameter**:
   ```
   GET /api/cron/expire?token=your-secret-token-here
   ```

## 各プラットフォームでの設定方法

### Vercel（Vercel Cron）

`vercel.json`に以下を追加：

```json
{
  "crons": [
    {
      "path": "/api/cron/expire",
      "schedule": "0 0 * * *"
    },
    {
      "path": "/api/cron/grant",
      "schedule": "59 23 * * *"
    }
  ]
}
```

環境変数に`CRON_SECRET_TOKEN`を設定します。

### Heroku（Heroku Scheduler）

1. Heroku Schedulerアドオンを追加：
   ```bash
   heroku addons:create scheduler:standard
   ```

2. Heroku DashboardでSchedulerを開き、以下のジョブを追加：

   **失効処理**:
   - コマンド: `curl -X GET "https://your-app.herokuapp.com/api/cron/expire?token=$CRON_SECRET_TOKEN"`
   - スケジュール: `0 0 * * *` (毎日 0:00 UTC)

   **自動付与処理**:
   - コマンド: `curl -X GET "https://your-app.herokuapp.com/api/cron/grant?token=$CRON_SECRET_TOKEN"`
   - スケジュール: `59 23 * * *` (毎日 23:59 UTC) または `0 0 * * *` (毎日 0:00 UTC)

3. 環境変数に`CRON_SECRET_TOKEN`を設定：
   ```bash
   heroku config:set CRON_SECRET_TOKEN=your-secret-token-here
   ```

### 外部Cronサービス（cron-job.org、EasyCronなど）

1. 新しいジョブを作成
2. URLを設定：
   - 失効処理: `https://your-app.com/api/cron/expire?token=your-secret-token`
   - 自動付与: `https://your-app.com/api/cron/grant?token=your-secret-token`
3. スケジュールを設定：
   - 失効処理: 毎日 0:00 UTC
   - 自動付与: 毎日 23:59 UTC または 0:00 UTC

### Node.js Cron（サーバーサイド）

`node-cron`パッケージを使用：

```bash
npm install node-cron
```

`scripts/cron-scheduler.js`を作成：

```javascript
const cron = require('node-cron')
const https = require('https')

const BASE_URL = process.env.APP_URL || 'http://localhost:3000'
const CRON_TOKEN = process.env.CRON_SECRET_TOKEN

// 失効処理: 毎日 0:00（JST 9:00）
cron.schedule('0 0 * * *', async () => {
  console.log('Running expire job...')
  try {
    const response = await fetch(`${BASE_URL}/api/cron/expire?token=${CRON_TOKEN}`)
    const data = await response.json()
    console.log('Expire job result:', data)
  } catch (error) {
    console.error('Expire job error:', error)
  }
})

// 自動付与: 毎日 23:59（JST 8:59）
cron.schedule('59 23 * * *', async () => {
  console.log('Running grant job...')
  try {
    const response = await fetch(`${BASE_URL}/api/cron/grant?token=${CRON_TOKEN}`)
    const data = await response.json()
    console.log('Grant job result:', data)
  } catch (error) {
    console.error('Grant job error:', error)
  }
})

console.log('Cron scheduler started')
```

`package.json`に追加：

```json
{
  "scripts": {
    "cron:start": "node scripts/cron-scheduler.js"
  }
}
```

## タイムゾーンの注意

- APIエンドポイントはUTCで動作します
- 日本時間（JST）で実行したい場合：
  - 失効処理: `0 0 * * *` (UTC) = 9:00 JST
  - 自動付与: `59 23 * * *` (UTC) = 8:59 JST（前日に実行）または `0 0 * * *` (UTC) = 9:00 JST（当日に実行）

## 手動実行（テスト用）

### 失効処理
```bash
curl -X GET "http://localhost:3000/api/cron/expire?token=your-secret-token"
```

### 自動付与処理
```bash
curl -X GET "http://localhost:3000/api/cron/grant?token=your-secret-token"
```

## ログ確認

各エンドポイントはJSON形式で結果を返します：

```json
{
  "success": true,
  "timestamp": "2025-11-01T00:00:00.000Z",
  "expiredCount": 5,
  "message": "5件のロットを失効処理しました"
}
```

## トラブルシューティング

1. **401 Unauthorized**: `CRON_SECRET_TOKEN`が設定されているか確認
2. **500 Internal Server Error**: サーバーログを確認
3. **実行されない**: cronサービスの設定を確認（スケジュール、URL、認証）

