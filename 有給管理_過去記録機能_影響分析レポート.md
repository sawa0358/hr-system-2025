# 有給管理過去記録機能 影響分析レポート

## 📋 実装内容の概要

有給管理の過去記録をPDF化してDLできる機能を追加しました。

### 追加された機能
1. **データベーススキーマ**: `LeaveHistorySnapshot`モデルを追加
2. **APIエンドポイント**: 履歴取得、保存、ダウンロード用のAPIを追加
3. **自動バッチ処理**: 新付与日の前日にスナップショットを自動保存
4. **画像/PDF生成**: Puppeteerを使用してサーバーサイドで自動生成
5. **UIコンポーネント**: 過去記録セレクターを追加

---

## 🔍 他への影響分析

### ✅ 影響なし（安全）

#### 1. 既存の有給管理機能への影響
- **影響**: なし
- **理由**: 
  - 既存の有給管理API（`/api/vacation/stats/[employeeId]`、`/api/vacation/requests`など）は変更なし
  - 既存の有給統計計算ロジック（`lib/vacation-stats.ts`）は変更なし
  - 既存の付与ロット生成機能（`lib/vacation-lot-generator.ts`）は変更なし
  - 新しい機能は既存機能とは独立して動作

#### 2. データベースへの影響
- **影響**: 最小限（新しいテーブルのみ追加）
- **理由**:
  - `leave_history_snapshots`テーブルを新規追加
  - 既存のテーブル構造は変更なし
  - 既存のデータには影響なし
  - インデックスを適切に設定しており、既存クエリへの影響は最小限

#### 3. 既存のAPIエンドポイントへの影響
- **影響**: なし
- **理由**:
  - 新しいAPIエンドポイント（`/api/vacation/history/*`）を追加したのみ
  - 既存のAPIエンドポイント（`/api/vacation/stats/*`、`/api/vacation/requests/*`など）は変更なし
  - パスが競合しない

---

## ⚠️ 注意が必要な点

### 1. データベースマイグレーションが必要

#### 影響
- **新しいテーブル**: `leave_history_snapshots`テーブルを作成する必要がある
- **既存のデータ**: 影響なし（新規テーブルのみ）

#### 対応方法
```bash
# マイグレーション実行
npx prisma migrate dev --name add_leave_history_snapshots

# または本番環境の場合
npx prisma migrate deploy
```

#### リスク
- **低リスク**: 新規テーブルのみ追加で、既存テーブルへの変更なし
- **ロールバック**: 必要に応じてマイグレーションをロールバック可能

---

### 2. Puppeteerのリソース使用

#### 影響
- **メモリ使用量**: Puppeteerは約100-200MBのメモリを使用
- **CPU使用量**: 画像/PDF生成時に一時的にCPU使用率が上昇
- **実行時間**: 1件あたり約2-5秒かかる可能性

#### 影響範囲
- **バッチ処理時**: 新付与日の前日に複数社員分を生成する場合、処理時間が長くなる可能性
- **同時実行**: 複数のリクエストが同時に来た場合、メモリ不足になる可能性

#### 対策
- **エラーハンドリング**: 画像/PDF生成に失敗してもスナップショットデータは保存
- **非同期処理**: バッチ処理は非同期で実行され、既存のロット生成処理に影響しない
- **タイムアウト設定**: 30秒のタイムアウトを設定

#### 推奨事項
- **Heroku環境**: Puppeteer用のビルドパックが必要（`heroku-buildpack-puppeteer`）
- **メモリ制限**: HerokuのDynoメモリ制限を確認（Standard-1X以上推奨）
- **同時実行制限**: 必要に応じて、同時実行数を制限する

---

### 3. S3ストレージ使用量の増加

#### 影響
- **ストレージ使用量**: 1社員あたり年間約2-5MB（PNG + PDF）
- **例**: 100社員の場合、年間約200-500MB

#### コスト見積もり
- **S3ストレージ**: ¥2.80 / GB / 月
- **100社員の場合**: 年間約500MB = 約¥1.4 / 月（非常に低コスト）

#### 対策
- **ファイルサイズ**: PNGとPDFの両方を保存（必要に応じて片方のみに変更可能）
- **ライフサイクルポリシー**: 古いファイルを自動削除する設定を追加可能

---

### 4. 日次スケジューラへの影響

#### 影響
- **処理時間**: スナップショット生成により、処理時間が若干増加する可能性
- **エラー処理**: スナップショット生成に失敗しても、既存のロット生成処理は続行

#### 現在の実装
```typescript
// ロット生成処理（既存）
const results = await generateGrantLotsForAllEmployees(today)

// スナップショット生成（新規、エラー時も続行）
try {
  // スナップショット生成処理
} catch (snapshotError) {
  // エラーをログに記録するが、処理は続行
}
```

#### 影響範囲
- **既存のロット生成**: 影響なし（独立して実行）
- **処理時間**: 新付与日の前日のみ、処理時間が若干増加
- **エラー時の動作**: スナップショット生成に失敗しても、ロット生成は正常に完了

---

### 5. パッケージサイズの増加

#### 影響
- **Puppeteer**: 約200-300MB（node_modulesに追加）
- **ビルド時間**: 若干増加する可能性

#### 対策
- **Heroku**: ビルドパックを使用して、Puppeteerを効率的にインストール
- **開発環境**: ローカル開発時も`npm install`で自動インストール

---

## 📊 パフォーマンスへの影響

### 1. APIレスポンス時間
- **履歴取得API**: 既存の有給統計APIと同程度（データベースクエリのみ）
- **ダウンロードAPI**: S3から署名付きURLを取得するため、既存のファイルダウンロードAPIと同程度

### 2. データベースクエリ
- **インデックス**: `employeeId`と`grantYear`にインデックスを設定しており、クエリは高速
- **既存クエリへの影響**: なし（新しいテーブルのみ）

### 3. メモリ使用量
- **通常時**: 影響なし（Puppeteerは使用時のみ起動）
- **バッチ処理時**: 一時的にメモリ使用量が増加（処理完了後に解放）

---

## 🔒 セキュリティへの影響

### 1. 権限チェック
- **実装済み**: 総務・管理者のみアクセス可能
- **既存の権限システム**: 変更なし（`lib/permissions.ts`を使用）

### 2. ファイルアクセス
- **S3署名付きURL**: 1時間有効な一時的なURLを生成
- **プライベートファイル**: ACLを`private`に設定

### 3. データ保護
- **社員情報**: 既存のセキュリティポリシーに準拠
- **スナップショットデータ**: 既存の有給データと同じレベルの保護

---

## 🚀 デプロイ時の注意事項

### 1. データベースマイグレーション
```bash
# 開発環境
npx prisma migrate dev --name add_leave_history_snapshots

# 本番環境
npx prisma migrate deploy
```

### 2. Puppeteerのセットアップ（Heroku）
```bash
# ビルドパックを追加
heroku buildpacks:add --index 1 heroku/nodejs
heroku buildpacks:add --index 2 jontewks/puppeteer
```

### 3. 環境変数
- **追加不要**: 既存のS3環境変数を使用
- **確認**: `AWS_S3_BUCKET_NAME`が設定されていることを確認

---

## 📈 長期的な影響

### 1. データベースサイズ
- **年間増加量**: 1社員あたり約1-2KB（スナップショットデータのみ）
- **100社員の場合**: 年間約100-200KB（非常に小さい）

### 2. S3ストレージ
- **年間増加量**: 1社員あたり約2-5MB（画像 + PDF）
- **100社員の場合**: 年間約200-500MB

### 3. バッチ処理の負荷
- **実行頻度**: 新付与日の前日のみ（年間数回）
- **処理時間**: 社員数に応じて増加（1社員あたり約2-5秒）

---

## ✅ 結論

### 影響の総括
1. **既存機能への影響**: **なし** ✅
2. **データベースへの影響**: **最小限**（新規テーブルのみ）✅
3. **パフォーマンスへの影響**: **最小限**（バッチ処理時のみ）⚠️
4. **セキュリティへの影響**: **なし**（既存の権限システムを使用）✅
5. **コストへの影響**: **非常に低い**（年間約¥1-2 / 100社員）✅

### 推奨事項
1. **データベースマイグレーション**: 必ず実行する
2. **Puppeteerのセットアップ**: Heroku環境ではビルドパックを追加
3. **監視**: バッチ処理の実行時間とエラー率を監視
4. **ストレージ管理**: 必要に応じて、古いファイルのライフサイクルポリシーを設定

### リスク評価
- **総合リスク**: **低リスク** ✅
- **既存機能への影響**: **なし** ✅
- **新機能の安定性**: **高い**（エラーハンドリングを実装）✅

---

## 📝 チェックリスト

デプロイ前に確認すべき項目：

- [ ] データベースマイグレーションを実行
- [ ] Puppeteerが正しくインストールされているか確認
- [ ] Heroku環境でビルドパックを追加（本番環境の場合）
- [ ] S3環境変数が設定されているか確認
- [ ] バッチ処理のエラーログを確認
- [ ] 過去記録セレクターが正しく表示されるか確認
- [ ] PDFダウンロードが正常に動作するか確認

---

**作成日**: 2025年11月1日
**バージョン**: 1.0















