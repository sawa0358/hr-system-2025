# 有給管理システム 開発順序提案

## 📋 現状確認

### 実装済み
- ✅ 設定画面（`/leave/settings`）
- ✅ 管理者画面（`/leave/admin`）
- ✅ 社員画面（`/leave`）
- ✅ 基本的なAPIエンドポイント（設定保存、統計取得、申請作成）
- ✅ 付与ロット生成ロジック
- ✅ 日次スケジューラ（自動付与用）

### 未実装・改善が必要
- ❌ サイドバーメニューの雇用形態フィルタリング
- ❌ 社員画面での申請一覧表示
- ❌ 管理者画面での申請待ち一覧表示
- ❌ 次回付与日・付与日数の正確な表示
- ❌ 社員カード内の直近申請情報表示

---

## 🎯 開発順序提案（優先度順）

### Phase 1: 社員側 - 基本機能の実装 ⭐⭐⭐

#### 1-1. サイドバーメニューに有給管理ボタンを追加（雇用形態フィルタリング）⭐⭐⭐
**優先度: 最高**

**実装内容:**
- `components/sidebar.tsx`の`dropdownMenuItems`にある「有給管理」の表示条件を追加
- 現在のユーザーの`employeeType`を取得
- 「正社員」「契約社員」「パートタイム」「派遣社員」のみ表示
- それ以外（業務委託、外注先など）は非表示

**実装箇所:**
- `components/sidebar.tsx` - `visibleDropdownItems`のフィルタリングロジックを追加

**所要時間:** 1-2時間

**影響:**
- 対象外の雇用形態の社員には「有給管理」メニューが表示されない

---

#### 1-2. 新規申請フォームの機能化 ⭐⭐⭐
**優先度: 最高**

**現状:**
- `yukyu-system/components/vacation-request-form.tsx`は存在するが、完全に機能していない可能性

**実装内容:**
- API `/api/vacation/request`へのPOSTリクエストを確認・修正
- バリデーション（残日数チェック、申請日の妥当性チェック）
- 成功時のトースト通知とリロード
- エラーハンドリングの強化

**実装箇所:**
- `yukyu-system/components/vacation-request-form.tsx`
- `app/api/vacation/request/route.ts`（確認・修正）

**所要時間:** 2-3時間

**影響:**
- 社員が有給申請を実際に送信できるようになる

---

#### 1-3. 申請一覧表示の機能化 ⭐⭐⭐
**優先度: 高**

**現状:**
- `yukyu-system/components/vacation-list.tsx`は存在するが、社員モードでの申請一覧が完全に機能していない

**実装内容:**
- API `/api/vacation/requests?employeeId=xxx`を実装・確認
- 社員モードで、直前の付与日以降の申請を表示
- フィルタリング（ステータス: 承認済み、申請中、却下済み）
- ソート機能（日付順、ステータス順、日数順）

**実装箇所:**
- `app/api/vacation/requests/route.ts`（確認・修正）
- `yukyu-system/components/vacation-list.tsx`（社員モードの実装）

**所要時間:** 3-4時間

**影響:**
- 社員が自分の申請履歴を確認できるようになる

---

### Phase 2: 管理者側 - 承認機能の実装 ⭐⭐

#### 2-1. 申請待ち一覧の表示 ⭐⭐⭐
**優先度: 最高**

**実装内容:**
- 管理者画面（`/leave/admin`）の「承認待ち」タブで、`status: "PENDING"`の申請のみ表示
- 各申請カードに「承認」「却下」ボタンを表示
- 申請の詳細（開始日、終了日、日数、理由）を表示

**実装箇所:**
- `yukyu-system/components/vacation-list.tsx`（管理者モードのフィルタリング）
- `app/api/vacation/admin/applicants/route.ts`（申請待ちフィルタリング）

**所要時間:** 2-3時間

**影響:**
- 管理者が承認待ちの申請を一目で確認できるようになる

---

#### 2-2. 次回付与日・付与日数の正確な表示 ⭐⭐
**優先度: 高**

**実装内容:**
- API `/api/vacation/admin/applicants`に`nextGrantDate`と`nextGrantDays`を追加
- `lib/vacation-stats.ts`の`getNextGrantDateForEmployee`関数を確認・修正
- 各社員カードに「次回付与日」と「付与日数」を表示

**実装箇所:**
- `lib/vacation-stats.ts` - `getNextGrantDateForEmployee`関数
- `lib/vacation-lot-generator.ts` - 次回付与日計算ロジック
- `app/api/vacation/admin/applicants/route.ts` - レスポンスに追加
- `yukyu-system/components/vacation-list.tsx` - 表示追加

**所要時間:** 3-4時間

**影響:**
- 管理者が各社員の次回付与情報を正確に把握できる

---

#### 2-3. 社員カード内の直近申請情報表示 ⭐⭐
**優先度: 中**

**実装内容:**
- 社員カードの右下（6個の表示窓の右下）に、最新の申請情報を表示
- 最新申請のステータス（申請中、承認済み、却下済み）を表示
- 申請日、日数を表示

**実装箇所:**
- `yukyu-system/components/vacation-list.tsx` - 社員カードのレイアウト修正
- `app/api/vacation/admin/applicants/route.ts` - 最新申請情報を取得

**所要時間:** 2-3時間

**影響:**
- 管理者が各社員の直近の申請状況を一目で確認できる

---

### Phase 3: API・リレーションの完全実装 ⭐

#### 3-1. 全てのAPIエンドポイントの確認・修正 ⭐⭐
**優先度: 高**

**確認・修正が必要なAPI:**
- ✅ `POST /api/vacation/request` - 申請作成（確認済みだが再確認）
- ✅ `GET /api/vacation/requests` - 申請一覧取得（社員IDフィルタリング）
- ✅ `GET /api/vacation/admin/applicants` - 管理者用社員一覧（次回付与日追加）
- ✅ `POST /api/vacation/requests/[id]/approve` - 承認（確認済み）
- ✅ `POST /api/vacation/requests/[id]/reject` - 却下（確認済み）
- ✅ `GET /api/vacation/stats/[employeeId]` - 社員統計（確認済み）

**実装箇所:**
- 各APIルートファイル

**所要時間:** 4-6時間

**影響:**
- 全てのAPIが正しく動作するようになる

---

#### 3-2. データベースリレーションの確認 ⭐
**優先度: 中**

**確認事項:**
- `TimeOffRequest`と`Employee`のリレーション
- `GrantLot`と`Employee`のリレーション
- `Consumption`と`TimeOffRequest`、`GrantLot`のリレーション

**実装箇所:**
- `prisma/schema-base.prisma`（スキーマ確認）
- 各APIでのリレーション取得

**所要時間:** 2-3時間

**影響:**
- データの整合性が保証される

---

## 📅 推奨実装スケジュール

### Week 1: 社員側基本機能
- Day 1-2: サイドバーメニューフィルタリング（1-1）
- Day 3-5: 新規申請機能化（1-2）
- Day 6-7: 申請一覧表示（1-3）

### Week 2: 管理者側機能
- Day 1-2: 申請待ち一覧表示（2-1）
- Day 3-5: 次回付与日・付与日数表示（2-2）
- Day 6-7: 直近申請情報表示（2-3）

### Week 3: API・リレーション完全実装
- Day 1-3: APIエンドポイントの確認・修正（3-1）
- Day 4-5: データベースリレーションの確認（3-2）
- Day 6-7: 統合テスト・バグ修正

---

## 🔄 実装時の注意事項

### データ整合性
- 申請作成時、残日数をチェック
- 申請承認時、`Consumption`レコードを作成し、`GrantLot`の`daysRemaining`を減算
- LIFO形式で、新しいロットから消費

### エラーハンドリング
- 全てのAPIエンドポイントで適切なエラーハンドリングを実装
- フロントエンドでユーザーフレンドリーなエラーメッセージを表示

### パフォーマンス
- 大量の申請がある場合のページネーション
- データ取得時の最適化（必要なフィールドのみ取得）

---

## ✅ 完了チェックリスト

### 社員側
- [ ] サイドバーに有給管理ボタンが表示される（雇用形態フィルタリング済み）
- [ ] 新規申請フォームが正常に動作する
- [ ] 申請送信後、トースト通知が表示される
- [ ] 申請一覧が表示される（直前の付与日以降）
- [ ] 申請一覧のフィルタリング・ソートが動作する

### 管理者側
- [ ] 申請待ち一覧が正しく表示される
- [ ] 承認・却下ボタンが動作する
- [ ] 全社員カードに次回付与日・付与日数が表示される
- [ ] 社員カード内の直近申請情報が表示される

### API・リレーション
- [ ] 全てのAPIエンドポイントが正常に動作する
- [ ] データベースリレーションが正しく設定されている
- [ ] エラーハンドリングが適切に実装されている

---

## 📝 実装開始時の準備

1. **ブランチ作成**
   ```bash
   git checkout -b feature/vacation-management-phase1
   ```

2. **開発順序**
   - Phase 1から順に実装
   - 各フェーズ完了後にコミット・プッシュ

3. **テスト**
   - 各機能実装後に動作確認
   - ブラウザの開発者ツールでエラーを確認

---

## 🚀 次のステップ

まず**Phase 1-1（サイドバーメニューの雇用形態フィルタリング）**から実装を開始することを推奨します。

